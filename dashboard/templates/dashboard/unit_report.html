{% extends 'theme/base.html' %}
{% load static %}

{% block title %}Unit Report - {{ unit.name }}{% endblock %}

{% block content %}
<div class="h-full overflow-y-auto">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-blue-950">Unit Report</h1>
                    <p class="text-gray-600 mt-2">{{ unit.facility.name }} / {{ unit.name }}</p>
                </div>
                <a href="{% url 'units_home' %}" class="btn bg-blue-950 hover:bg-blue-800 text-white">
                    ← Back to Units
                </a>
            </div>

            <div class="stats shadow bg-white">
                <div class="stat">
                    <div class="stat-title">Facility</div>
                    <div class="stat-value text-2xl text-blue-950">{{ unit.facility.name }}</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Unit</div>
                    <div class="stat-value text-2xl text-blue-950">{{ unit.name }}</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Total Components</div>
                    <div class="stat-value text-2xl text-green-600">{{ components.count }}</div>
                </div>
            </div>
        </div>

        <!-- Risk Matrix Card -->
        <div class="card bg-white shadow-xl mb-8">
            <div class="card-body">
                <h2 class="card-title text-blue-950 text-2xl mb-4">Risk Distribution (API 581)</h2>

                <div class="risk-matrix-container">
                    <div id="unit-risk-matrix" class="risk-matrix-grid">
                        <!-- Grid cells will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Legend -->
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <div class="flex items-center gap-2">
                        <div style="width: 20px; height: 20px;" class="risk-low rounded"></div>
                        <span class="text-sm font-semibold text-gray-700">Low</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div style="width: 20px; height: 20px;" class="risk-medium rounded"></div>
                        <span class="text-sm font-semibold text-gray-700">Medium</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div style="width: 20px; height: 20px;" class="risk-medium-high rounded"></div>
                        <span class="text-sm font-semibold text-gray-700">Med-High</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div style="width: 20px; height: 20px;" class="risk-high rounded"></div>
                        <span class="text-sm font-semibold text-gray-700">High</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Components Table -->
        <div class="card bg-white shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-blue-950 text-2xl mb-6">Components List</h2>

                {% if components %}
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead class="bg-blue-950 text-white">
                            <tr>
                                <th>#</th>
                                <th>Equipment</th>
                                <th>Component Type</th>
                                <th>Material</th>
                                <th class="text-center">POF Cat.</th>
                                <th class="text-center">COF Cat.</th>
                                <th class="text-right">CA (m²)</th>
                                <th class="text-right">Df-total</th>
                                <th class="text-right">Risk (m²/yr)</th>
                                <th class="text-right">CoF ($)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for component in components %}
                            <tr class="hover">
                                <td>{{ forloop.counter }}</td>
                                <td class="font-semibold">{{ component.equipment.number }}</td>
                                <td>{{ component.get_rbix_component_type_display }}</td>
                                <td>{{ component.material_construction|default:"-" }}</td>
                                <td class="text-center">
                                    {% if component.pof_category %}
                                    <span class="badge badge-primary font-bold">{{ component.pof_category }}</span>
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if component.cof_category %}
                                    <span
                                        class="badge {% if component.cof_category == 'A' %}badge-success{% elif component.cof_category == 'B' %}badge-info{% elif component.cof_category == 'C' %}badge-warning{% elif component.cof_category == 'D' %}badge-error{% elif component.cof_category == 'E' %}badge-error{% endif %} font-bold">
                                        {{ component.cof_category }}</span>
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right font-mono">
                                    {% if component.calculated_consequence_area %}
                                    {{ component.calculated_consequence_area|floatformat:2 }}
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right font-mono">
                                    {% if component.calculated_total_damage_factor %}
                                    {{ component.calculated_total_damage_factor|floatformat:2 }}
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right font-mono">
                                    {% if component.calculated_risk %}
                                    <span
                                        class="{% if component.calculated_risk > 4 %}text-red-600 font-bold{% else %}text-green-600{% endif %}">
                                        {{ component.calculated_risk|floatformat:4 }}
                                    </span>
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right font-mono">
                                    {% if component.calculated_cof %}
                                    ${{ component.calculated_cof|floatformat:0 }}
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'component_report' component.pk %}"
                                        class="btn btn-sm bg-blue-950 hover:bg-blue-900 text-white">
                                        View/Edit
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        class="stroke-current shrink-0 w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>No components found for this unit.</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Info Note -->
        <div class="alert alert-warning shadow-lg mt-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
                <h3 class="font-bold">Note about Calculated Values</h3>
                <div class="text-sm">Calculated values (CA, Df-total, Risk, CoF) are only populated after opening and
                    saving
                    each component in the report view. Empty values indicate the component hasn't been calculated yet.
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Matrix Styles -->
    <style>
        .risk-matrix-container {
            display: flex;
            justify-content: center;
            padding: 20px;
            overflow-x: auto;
        }

        .risk-matrix-grid {
            display: grid !important;
            grid-template-columns: 80px repeat(5, 90px) !important;
            grid-template-rows: repeat(5, 90px) 60px !important;
            gap: 2px !important;
            background: #e5e7eb !important;
            padding: 2px !important;
            border: 1px solid #d1d5db;
        }

        .risk-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            position: relative;
            cursor: default;
            transition: all 0.2s;
            font-size: 24px;
        }

        .risk-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .axis-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #4b5563;
            background: #f3f4f6;
            text-align: center;
            padding: 4px;
        }

        .axis-label-y {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
        }

        /* Color coding */
        .risk-low {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .risk-medium {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }

        .risk-medium-high {
            background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
        }

        .risk-high {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .risk-count-badge {
            background: rgba(255, 255, 255, 0.9);
            color: #1f2937;
            border-radius: 9999px;
            padding: 2px 8px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Safe data serialization
            const componentsData = [
                {% for component in components %}
                {
                pof: "{{ component.pof_category|default:'' }}",
                cof: "{{ component.cof_category|default:'' }}",
                name: "{{ component.equipment.number }}",
                id: "{{ component.id }}"
            },
            {% endfor %}
            ];

        renderUnitRiskMatrix(componentsData);
        });

        function renderUnitRiskMatrix(data) {
            const container = document.getElementById('unit-risk-matrix');
            if (!container) return;

            container.innerHTML = '';

            const pofLabels = ['POF', '5', '4', '3', '2', '1'];
            const cofLabels = ['COF', 'A', 'B', 'C', 'D', 'E'];

            // Group components per cell
            const matrixItems = {}; // Key: "POF-COF" -> Array of component names

            data.forEach(item => {
                if (item.pof && item.cof) {
                    const key = `${item.pof}-${item.cof}`;
                    if (!matrixItems[key]) {
                        matrixItems[key] = [];
                    }
                    matrixItems[key].push(item.name);
                }
            });

            const gridRows = 6;
            const gridCols = 6;

            for (let row = 0; row < gridRows; row++) {
                for (let col = 0; col < gridCols; col++) {
                    const cell = document.createElement('div');

                    // Y-axis labels
                    if (col === 0 && row >= 0) {
                        const isDataRow = row < (gridRows - 1);
                        cell.className = 'axis-label' + (isDataRow ? ' axis-label-y' : '');
                        if (isDataRow) {
                            cell.innerHTML = `<div>${pofLabels[row + 1]}</div>`;
                        } else {
                            cell.innerHTML = `<div>Rate</div>`;
                        }
                        container.appendChild(cell);
                        continue;
                    }

                    // X-axis labels
                    if (row === (gridRows - 1) && col > 0) {
                        cell.className = 'axis-label';
                        cell.innerHTML = `<div>${cofLabels[col]}</div>`;
                        container.appendChild(cell);
                        continue;
                    }

                    // Risk cells
                    if (col > 0 && row < (gridRows - 1)) {
                        const pofValue = 5 - row; // 5, 4, 3, 2, 1
                        const cofCategory = cofLabels[col]; // A, B, C, D, E
                        const cofIndex = col; // 1-5

                        const riskLevel = calculateRiskLevel(pofValue, cofIndex);

                        cell.className = `risk-cell ${getRiskColorClass(riskLevel)}`;

                        // Add items if exists
                        const items = matrixItems[`${pofValue}-${cofCategory}`] || [];
                        const count = items.length;

                        if (count > 0) {
                            const badge = document.createElement('span');
                            badge.className = 'risk-count-badge';
                            badge.textContent = count;
                            cell.appendChild(badge);

                            // Create tooltip content
                            const maxItemsToShow = 20;
                            let tooltipText = `${count} Components (POF ${pofValue}, COF ${cofCategory}):\n\n`;
                            tooltipText += items.slice(0, maxItemsToShow).map(name => `• ${name}`).join('\n');

                            if (count > maxItemsToShow) {
                                tooltipText += `\n\n... and ${count - maxItemsToShow} more`;
                            }

                            cell.title = tooltipText;

                            // Make clickable to filter? (Optional future enhancement)
                            cell.style.cursor = 'pointer';
                        } else {
                            // Empty cell title
                            cell.title = `POF ${pofValue}, COF ${cofCategory} (Empty)`;
                        }

                        container.appendChild(cell);
                    }
                }
            }
        }

        function calculateRiskLevel(pof, cofIndex) {
            // Simple risk scoring: sum of POF + COF index
            const riskScore = pof + cofIndex;

            // Risk thresholds (API 580 guideline)
            if (riskScore <= 3) return 'low';           // Green
            if (riskScore <= 5) return 'medium';        // Yellow
            if (riskScore <= 7) return 'medium-high';   // Orange
            return 'high';                              // Red
        }

        function getRiskColorClass(level) {
            const colors = {
                'low': 'risk-low',
                'medium': 'risk-medium',
                'medium-high': 'risk-medium-high',
                'high': 'risk-high'
            };
            return colors[level] || 'risk-low';
        }
    </script>
</div>
{% endblock %}