{%extends 'theme/base.html'%}
{% load static %}

{%block title%}{% if is_edit %}Edit Component{% else %}Create Component{% endif %}{%endblock%}

<style>
    /* Risk Matrix Styles */
    .risk-matrix-container {
        display: flex;
        justify-content: center;
        padding: 20px;
        overflow-x: auto;
    }


    .risk-matrix-grid {
        display: grid !important;
        grid-template-columns: 80px repeat(5, 90px) !important;
        grid-template-rows: repeat(5, 90px) 60px !important;
        gap: 2px !important;
        background: #e5e7eb !important;
        padding: 2px !important;
        border: 1px solid #d1d5db;
    }

    .risk-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        position: relative;
        cursor: help;
        transition: all 0.2s;
        font-size: 20px;
    }

    .risk-cell:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }

    .risk-cell.current-position {
        border: 5px solid #1e40af;
        box-shadow: 0 0 25px rgba(30, 64, 175, 0.6);
        z-index: 20;
    }

    .risk-cell.current-position::after {
        content: "✓";
        position: absolute;
        font-size: 32px;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .axis-label {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        color: #4b5563;
        background: #f3f4f6;
        text-align: center;
        padding: 4px;
    }

    .axis-label-y {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
    }

    /* Color coding */
    .risk-low {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .risk-medium {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .risk-medium-high {
        background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
    }

    .risk-high {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
</style>

{% block nav_content %}
<div class="flex justify-end items-center h-full">
    <ul class="menu menu-horizontal p-0 hidden lg:flex text-white space-x-2">
        <li><a id="logout_btn" href="{% url 'logout' %}"
                class="btn btn-ghost text-white hover:bg-blue-800 transition duration-200">Log out</a></li>
        <li><a href="#" class="btn btn-ghost text-white hover:bg-blue-800 transition duration-200">Account</a></li>
    </ul>

    <label for="my-drawer" class="btn btn-square btn-ghost text-white lg:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            class="inline-block w-6 h-6 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </label>
</div>
{% endblock %}

{%block content%}

<div class="drawer h-full overflow-hidden">
    <input id="my-drawer" type="checkbox" class="drawer-toggle" />

    <div class="drawer-content flex flex-col h-full overflow-hidden">

        <main class="flex flex-1 h-full overflow-hidden">

            <!-- SIDEBAR -->
            <aside
                class="hidden lg:block w-64 bg-white p-6 shadow-xl border-r border-gray-200 flex-shrink-0 overflow-y-auto">
                {% include 'dashboard/includes/sidebar.html' %}
            </aside>
            <!-- END SIDEBAR -->

            <!-- MAIN CONTENT -->
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <!-- Breadcrumb -->
                <nav class="mb-6">
                    <ol class="flex items-center gap-2 text-sm">
                        <li class="flex items-center">
                            <a href="{% url 'dashboard_home' %}"
                                class="flex items-center gap-2 px-3 py-2 rounded-md text-gray-600 hover:text-blue-950 hover:bg-blue-50 transition-all duration-200 group">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    class="w-4 h-4 stroke-current group-hover:scale-110 transition-transform">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                                    </path>
                                </svg>
                                <span class="font-medium">Dashboard</span>
                            </a>
                        </li>

                        <li class="flex items-center text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </li>

                        <li class="flex items-center">
                            <a href="{% url 'components_home' %}"
                                class="flex items-center gap-2 px-3 py-2 rounded-md text-gray-600 hover:text-blue-950 hover:bg-blue-50 transition-all duration-200 group">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    class="w-4 h-4 stroke-current group-hover:scale-110 transition-transform">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                                    </path>
                                </svg>
                                <span class="font-medium">Components</span>
                            </a>
                        </li>

                        <li class="flex items-center text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </li>

                        <li class="flex items-center">
                            <span class="flex items-center gap-2 px-3 py-2 rounded-md bg-blue-950 text-white shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    class="w-4 h-4 stroke-current">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                <span class="font-semibold">{% if is_edit %}Edit{% else %}Create{% endif %}
                                    Component</span>
                            </span>
                        </li>
                    </ol>
                </nav>

                <!-- Page Header -->
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-blue-950">
                        {% if is_edit %}Edit Component{% else %}Create New Component{% endif %}
                    </h1>
                    <div class="flex gap-2">
                        {% if is_edit and component.equipment %}
                        <a href="#" class="btn bg-purple-600 hover:bg-purple-700 text-white border-none">View
                            Equipment</a>
                        {% endif %}
                        <a href="{% url 'components_home' %}"
                            class="btn btn-ghost text-blue-950 hover:bg-blue-100">Cancel</a>
                        <button type="submit" form="component-form"
                            class="btn bg-blue-950 hover:bg-blue-900 text-white border-none px-8">
                            {% if is_edit %}Save Changes{% else %}Create Component{% endif %}
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs tabs-boxed bg-white shadow-md mb-2">
                    <a class="tab tab-active text-blue-950 font-semibold" onclick="openMainTab(event, 'data')">Data</a>
                    <a class="tab text-gray-500 cursor-not-allowed">Metal Loss</a>
                    <a class="tab text-gray-500 cursor-not-allowed">Non-Metal Loss</a>
                    <a class="tab text-blue-500" onclick="openMainTab(event, 'probability')">Probability</a>
                    <a class="tab text-blue-500" onclick="openMainTab(event, 'consequence')">Consequence</a>
                    <a class="tab text-blue-500" onclick="openMainTab(event, 'risk')">Risk</a>
                    <a class="tab text-blue-500" onclick="openMainTab(event, 'inspection-planning')">Inspection
                        Planning</a>
                </div>

                <!-- Styles for custom purple theme -->
                <form method="post" id="component-form" novalidate>
                    {% csrf_token %}

                    {% if form.errors %}
                    <div class="alert alert-error mb-4 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="flex flex-col">
                            <span class="font-bold">Please correct the errors below:</span>
                            <ul class="list-disc list-inside text-sm mt-1">
                                {% for field in form %}
                                {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}

                    <!-- DATA TAB CONTENT -->
                    <div id="data-tab-content">

                        <!-- Sub-tabs for Data section -->
                        <div class="flex gap-2 mb-6 bg-gray-100 p-2 rounded-lg border border-gray-200">
                            <button type="button"
                                class="btn btn-sm bg-blue-950 hover:bg-blue-900 text-white border-none shadow-md font-semibold"
                                onclick="showSubTab('design', this)">Design / Installation</button>
                            <button type="button"
                                class="btn btn-sm bg-gray-200 hover:bg-gray-300 text-gray-700 border-none"
                                onclick="showSubTab('operating', this)">Operating & Process</button>
                            <button type="button"
                                class="btn btn-sm bg-gray-200 hover:bg-gray-300 text-gray-700 border-none"
                                onclick="showSubTab('inspection', this)">Inspection</button>
                        </div>

                        <!-- Design / Installation Section -->

                        <div id="design-section" class="bg-white shadow-md rounded-lg p-6">
                            <h2
                                class="text-lg font-bold mb-6 bg-blue-950 text-white py-2 px-4 -mx-6 -mt-6 rounded-t-lg">
                                Design / Installation</h2>

                            <div class="space-y-4">
                                <!-- Row 1: Equipment -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="form-control md:col-span-2">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">Equipment</span></label>
                                        {{ form.equipment }}
                                    </div>
                                </div>

                                <!-- Row 2: Equipment Type & Component Type -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">RBIX
                                                Equipment Type</span></label>
                                        {{ form.rbix_equipment_type }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">RBIX
                                                Component Type</span></label>
                                        {{ form.rbix_component_type }}
                                    </div>
                                </div>

                                <!-- Row 3: Description -->
                                <div class="form-control w-full">
                                    <label class="label"><span
                                            class="label-text font-semibold text-gray-700">Description</span></label>
                                    {{ form.description }}
                                </div>

                                <!-- Row 4: PFD, P&ID, Other Drawings -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">PFD</span></label>
                                        {{ form.pfd_no }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">P&ID</span></label>
                                        {{ form.p_and_id }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Other
                                                Drawings</span></label>
                                        {{ form.other_drawings }}
                                    </div>
                                </div>

                                <!-- Row 5: Dates and Lives Setup -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">Commissioning
                                                Date</span></label>
                                        {{ form.commissioning_date }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">RBI
                                                Calculation Date</span></label>
                                        {{ form.rbi_calculation_date }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Design
                                                Life (years)</span></label>
                                        {{ form.design_life_years }}
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">Component
                                                Life
                                                (years)</span></label>
                                        {{ form.component_life_years }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">Remaining
                                                Life
                                                (years)</span></label>
                                        {{ form.remaining_life_years }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">External
                                                Coating
                                                Installation Date</span></label>
                                        {{ form.external_coating_date }}
                                    </div>
                                </div>

                                <!-- Material Section -->
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">Material</span></label>
                                        {{ form.material }}
                                    </div>
                                    <div class="form-control">
                                        <button type="button" id="btnSelectMaterial"
                                            class="btn bg-blue-950 text-white hover:bg-blue-900 btn-block">Select
                                            Material</button>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-blue-950">RBIX
                                                Material</span></label>
                                        <!-- Hidden select for form submission -->
                                        <div style="display: none;">
                                            {{ form.material_construction }}
                                        </div>
                                        <input type="text" id="rbixMaterialDisplay"
                                            class="input input-bordered bg-gray-100" readonly
                                            placeholder="Select Material..."
                                            value="{{ form.instance.material_construction|default:'' }}">
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-blue-950">
                                                Cost Factor (CFAC)</span></label>
                                        {{ form.cost_factor }}
                                    </div>
                                </div>



                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-purple-700">RBIX
                                                Material Nominal Composition</span></label>
                                        {{ form.material_nominal_composition }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-purple-700">RBIX
                                                Material Specification No</span></label>
                                        {{ form.material_specification_no }}
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2 pt-8">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            <span class="label-text font-semibold text-gray-700">Sulphur Bearing
                                                Compounds</span>
                                            {{ form.sulphur_bearing_compounds }}
                                        </label>
                                    </div>
                                </div>

                                <!-- Design Conditions -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Design
                                                Pressure (psi)</span></label>
                                        {{ form.design_pressure_psi }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Design
                                                Temp. (deg F)</span></label>
                                        {{ form.design_temp_f }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">MDMT
                                                (deg F)</span></label>
                                        {{ form.mdmt_f }}
                                    </div>
                                </div>

                                <!-- Stress / Strength -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            <span class="label-text font-semibold text-purple-700">Stress / Strength
                                                Known</span>
                                            {{ form.stress_strength_known }}
                                        </label>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">Allowable
                                                Stress
                                                (psi)</span></label>
                                        {{ form.allowable_stress_psi }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">SMYS
                                                (Yield)(psi)</span></label>
                                        {{ form.smys_yield_psi }}
                                    </div>
                                </div>

                                <!-- Dimensions: Diameter -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Size
                                                Diameter (Rating)</span></label>
                                        {{ form.size_diameter_rating }}
                                    </div>
                                    <!-- Note: Reusing existing component_diameter for the "inches" field shown in mockup -->
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-purple-700">Size
                                                Diameter (inches)</span></label>
                                        {{ form.component_diameter }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Size
                                                Diameter (mm)</span></label>
                                        <input type="text" class="input input-bordered bg-gray-100" readonly value="">
                                    </div>
                                </div>

                                <!-- Dimensions: Thickness -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            <span class="label-text font-semibold text-purple-700">Nominal Thickness
                                                Known</span>
                                            {{ form.nominal_thickness_known }}
                                        </label>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">NT
                                                (inch)</span></label>
                                        {{ form.nominal_thickness_in }}
                                    </div>
                                    <div></div>
                                </div>

                                <!-- Dimensions: OD/ID/Safety -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">Outside
                                                Diameter(in)</span></label>
                                        {{ form.diameter_outside_in }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Inside
                                                Diameter(in)</span></label>
                                        {{ form.diameter_inside_in }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Safety
                                                Factor</span></label>
                                        {{ form.safety_factor }}
                                    </div>
                                </div>

                                <!-- Codes -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-purple-700">Design
                                                Code</span></label>
                                        {{ form.design_code }}
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2 mb-3">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            <span class="label-text font-semibold text-purple-700">PWHT</span>
                                            {{ form.pwht }}
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2 mb-3">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            <span class="label-text font-semibold text-purple-700">Heat Traced</span>
                                            {{ form.heat_traced }}
                                        </label>
                                    </div>
                                </div>

                                <!-- Corrosion/Insulation -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">Atmosphere
                                                Corrosivity</span></label>
                                        {{ form.atmosphere_corrosivity }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Joint
                                                Efficiency (0 to 1)</span></label>
                                        {{ form.joint_efficiency }}
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2 mb-3">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            <span class="label-text font-semibold text-purple-700">Internal
                                                Cladding</span>
                                            {{ form.internal_cladding }}
                                        </label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            <span class="label-text font-semibold text-purple-700">Internal
                                                Lining</span>
                                            {{ form.internal_lining }}
                                        </label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                    <div class="form-control flex flex-row items-center gap-2 mb-3">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            <span class="label-text font-semibold text-gray-700">Insulated</span>
                                            {{ form.insulated }}
                                        </label>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text font-semibold text-gray-700">Insulation
                                                Type</span></label>
                                        {{ form.insulation_type }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-semibold text-gray-700">Other
                                                Insulation</span></label>
                                        {{ form.other_insulation }}
                                    </div>
                                </div>

                            </div>

                            <!-- 4.12 Financial Consequence (Moved to Consequence Tab) -->
                            <!-- Section removed to prevent duplicate field IDs -->


                        </div>

                        <!-- Operating & Process Section (Hidden by default) -->
                        <div id="operating-section" class="hidden bg-white shadow-md rounded-lg p-6">
                            <h2
                                class="text-lg font-bold mb-6 bg-blue-950 text-white py-2 px-4 -mx-6 -mt-6 rounded-t-lg">
                                Operating & Process</h2>

                            <!-- Operating Temperature -->
                            <div class="mb-8">
                                <h3 class="text-md font-bold text-blue-950 mb-4 border-b pb-2">Operating Temperature
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Operating Temperature
                                                (deg
                                                F)</span>
                                        </label>
                                        {{ form.operating_temp_f }}
                                    </div>
                                    <div class="form-control md:col-span-2 flex flex-row items-center gap-2 pt-8">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            <span class="label-text text-gray-700">Component may operate at or below the
                                                MDMT</span>
                                            {{ form.component_may_operate_below_mdmt }}
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Operating Pressure -->
                            <div class="mb-8">
                                <h3 class="text-md font-bold text-blue-950 mb-4 border-b pb-2">Operating Pressure</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Operating Pressure
                                                (psia)</span>
                                        </label>
                                        {{ form.operating_pressure_psia }}
                                    </div>
                                </div>
                            </div>

                            <!-- Release Rate Parameters -->
                            <div class="mb-8">
                                <h3 class="text-md font-bold text-blue-950 mb-4 border-b pb-2">Release Rate Parameters
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Storage Pressure Ps
                                                (psia)</span>
                                        </label>
                                        {{ form.storage_pressure }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Atm. Pressure
                                                (psi)</span>
                                        </label>
                                        {{ form.atm_pressure }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Discharge Coeff.
                                                (Cd)</span>
                                        </label>
                                        {{ form.discharge_coeff }}
                                    </div>
                                </div>
                            </div>

                            <!-- Flow Properties -->
                            <div class="mb-8">
                                <h3 class="text-md font-bold text-blue-950 mb-4 border-b pb-2">Flow Properties</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Flow Velocity
                                                (ft/s)</span>
                                        </label>
                                        {{ form.flow_velocity_fts }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Inhibitor Efficiency
                                                (%)</span>
                                        </label>
                                        {{ form.inhibitor_efficiency_percent }}
                                    </div>
                                </div>
                            </div>

                            <!-- Fluid Information -->
                            <div class="mb-8">
                                <h3 class="text-md font-bold text-blue-950 mb-4 border-b pb-2">Fluid Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Fluid Name</span>
                                        </label>
                                        {{ form.fluid_name }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Fluid
                                                Description</span>
                                        </label>
                                        {{ form.fluid_description }}
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">RBIX Fluid</span>
                                        </label>
                                        {{ form.rbix_fluid }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Operational Fluid
                                                Phase</span>
                                        </label>
                                        {{ form.operational_fluid_phase }}
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Component Fluid Mass
                                                (lb)</span>
                                        </label>
                                        {{ form.component_fluid_mass_lb }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Component Group Fluid
                                                Mass
                                                (lb)</span>
                                        </label>
                                        {{ form.component_group_fluid_mass_lb }}
                                    </div>
                                </div>
                            </div>

                            <!-- Safety Systems Effectiveness -->
                            <div class="mb-8">
                                <h3 class="text-md font-bold text-blue-950 mb-4 border-b pb-2">Safety Systems
                                    Effectiveness
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Fluid Release Reduction
                                                Safety Systems Effectiveness</span>
                                        </label>
                                        {{ form.fluid_release_reduction_safety_effectiveness }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-blue-950 font-semibold">Fire Reduction Safety
                                                Systems Effectiveness</span>
                                        </label>
                                        {{ form.fire_reduction_safety_effectiveness }}
                                    </div>
                                </div>
                            </div>

                            <!-- Chemical Properties -->
                            <div class="mb-8">
                                <h3 class="text-md font-bold text-blue-950 mb-4 border-b pb-2">Chemical Properties</h3>
                                <div class="form-control max-w-xs mb-6">
                                    <label class="label">
                                        <span class="label-text text-blue-950 font-semibold">pH</span>
                                    </label>
                                    {{ form.ph_value }}
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_water }}
                                            <span class="label-text text-gray-700">Water</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_h2s }}
                                            <span class="label-text text-gray-700">H₂S</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_co2 }}
                                            <span class="label-text text-gray-700">CO₂</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_h2so4 }}
                                            <span class="label-text text-gray-700">H₂SO₄</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_hf }}
                                            <span class="label-text text-gray-700">HF</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_amine }}
                                            <span class="label-text text-gray-700">Amine</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_hcl }}
                                            <span class="label-text text-gray-700">HCl</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_oxygen }}
                                            <span class="label-text text-gray-700">Oxygen</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_sulphur }}
                                            <span class="label-text text-gray-700">Sulphur</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_chloride }}
                                            <span class="label-text text-gray-700">Chloride</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_hydrogen }}
                                            <span class="label-text text-gray-700">Hydrogen</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.high_hydrogen_partial_pressure }}
                                            <span class="label-text text-gray-700">Hydrogen partial pressure > 0.032 MPa
                                                [50
                                                psi]</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_oil }}
                                            <span class="label-text text-gray-700">Oil</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.contains_caustic }}
                                            <span class="label-text text-gray-700">Caustic</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.underground }}
                                            <span class="label-text text-gray-700">Underground</span>
                                        </label>
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            {{ form.cooling_water_service }}
                                            <span class="label-text text-gray-700">Cooling Water Service</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Chemical Concentrations (W%) -->
                                <h4 class="text-sm font-bold text-blue-950 mb-4 mt-6">Chemical Concentrations (W%)</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">H₂S (Hydrogen sulfide)(W%)</span>
                                        </label>
                                        {{ form.h2s_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">NH₃, Ammonia (W%)</span>
                                        </label>
                                        {{ form.nh3_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">CO₂ Carbon Monoxide (W%)</span>
                                        </label>
                                        {{ form.co2_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">HNO₃, Nitric Acid (W%)</span>
                                        </label>
                                        {{ form.hno3_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">H₂O₂, Nitrogen Dioxide (W%)</span>
                                        </label>
                                        {{ form.h2o2_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">COCl₂, Phosphine (W%)</span>
                                        </label>
                                        {{ form.cocl2_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">C₂H₄O₃, Ethylene Oxide (EO)
                                                (W%)</span>
                                        </label>
                                        {{ form.c2h4o3_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">C₃H₆O₂, Propylene Oxide (PO)
                                                (W%)</span>
                                        </label>
                                        {{ form.c3h6o2_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">Toluene Diisocynate (TDI) (W%)</span>
                                        </label>
                                        {{ form.toluene_diisocynate_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">C₃H₈O₂, Ethylene Glycol Monomethyl
                                                Ether
                                                (EE) (W%)</span>
                                        </label>
                                        {{ form.c3h8o2_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">AlCl₃, Aluminum Chloride (W%)</span>
                                        </label>
                                        {{ form.alcl3_concentration_wpercent }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text text-gray-700">Toxic Mass Fraction</span>
                                        </label>
                                        {{ form.toxic_mass_fraction_wpercent }}
                                    </div>
                                </div>
                            </div>

                        </div>



                        <!-- Inspection Section (Hidden by default) -->
                        <div id="inspection-section" class="hidden bg-white shadow-md rounded-lg p-6">
                            <h2
                                class="text-lg font-bold mb-6 bg-blue-950 text-white py-2 px-4 -mx-6 -mt-6 rounded-t-lg">
                                Inspection</h2>

                            <!-- Sub-tabs for Inspection -->
                            <div class="flex gap-2 mb-6 border-b pb-2">
                                <button type="button" onclick="showInspectionTab('internal', this)"
                                    class="px-4 py-2 rounded-t bg-blue-950 text-white font-semibold">Internal
                                    Inspection</button>
                                <button type="button" onclick="showInspectionTab('external', this)"
                                    class="px-4 py-2 rounded-t bg-gray-200 text-gray-700 hover:bg-gray-300">External
                                    Inspection</button>
                                <button type="button" onclick="showInspectionTab('thickness', this)"
                                    class="px-4 py-2 rounded-t bg-gray-200 text-gray-700 hover:bg-gray-300">Thickness</button>
                            </div>

                            <!-- Internal Inspection Tab -->
                            <div id="internal-inspection-tab" class="inspection-tab">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text text-blue-950 font-semibold">Int.
                                                Inspection (vol, Mil)</span></label>
                                        {{ form.int_inspection_vol_mil }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text text-blue-950 font-semibold">Last
                                                Int.
                                                Visual Inspection Date</span></label>
                                        {{ form.last_int_visual_inspection_date }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">Service
                                                Years Since Last Int. Visual Insp.</span></label>
                                        {{ form.service_years_since_last_int_visual_insp }}
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">Internal
                                                Lining Quality</span></label>
                                        {{ form.internal_lining_quality }}
                                    </div>
                                    <div class="form-control flex flex-row items-center gap-2 pt-8">
                                        <label class="label cursor-pointer justify-start gap-4">
                                            {{ form.internal_cracks_present }}
                                            <span class="label-text text-gray-700">Internal Cracks Present</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">Internal
                                                Crack Finding Capability</span></label>
                                        {{ form.internal_crack_finding_capability }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">Internal
                                                Corrosion Finding Capability</span></label>
                                        {{ form.internal_corrosion_finding_capability }}
                                    </div>
                                </div>

                                <!-- Internal Inspection History Table -->
                                <h3 class="text-md font-bold text-blue-950 mb-4 border-b pb-2">Internal Inspection
                                    History
                                </h3>
                                <div class="mb-4 flex justify-between items-center">
                                    <button type="button" class="btn btn-sm bg-blue-950 text-white hover:bg-blue-900"
                                        onclick="showAddInspectionModal('Internal')">
                                        <span class="text-lg">+</span> Add Internal Inspection
                                    </button>
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn btn-sm bg-blue-950 text-white hover:bg-blue-900">
                                            ✓ Save changes
                                        </button>
                                        <button type="button"
                                            class="btn btn-sm bg-gray-300 text-gray-700 hover:bg-gray-400">
                                            ⊘ Cancel changes
                                        </button>
                                    </div>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="table w-full">
                                        <thead class="bg-blue-950 text-white">
                                            <tr>
                                                <th>Method</th>
                                                <th>Date</th>
                                                <th>Lining Quality</th>
                                                <th>General Condition</th>
                                                <th>Crack Finding Capability</th>
                                                <th>Corrosion Finding Capability</th>
                                                <th>Comments</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="internal-history-tbody">
                                            <!-- Dynamic rows will be added here -->
                                            <tr class="text-gray-400 text-center">
                                                <td colspan="8">No inspection history records yet</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- External Inspection Tab -->
                            <div id="external-inspection-tab" class="inspection-tab hidden">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">External
                                                Inspection (vol, Mil)</span></label>
                                        {{ form.ext_inspection_vol_mil }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text text-blue-950 font-semibold">Last
                                                Ext.
                                                Visual Inspection Date</span></label>
                                        {{ form.last_ext_visual_inspection_date }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">Service
                                                Years Since Last Ext. Visual Insp.</span></label>
                                        {{ form.service_years_since_last_ext_visual_insp }}
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">External
                                                Coating Quality</span></label>
                                        {{ form.external_coating_quality }}
                                    </div>
                                    <div></div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">External
                                                Crack Finding Capability</span></label>
                                        {{ form.external_crack_finding_capability }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">External
                                                Corrosion Finding Capability</span></label>
                                        {{ form.external_corrosion_finding_capability }}
                                    </div>
                                </div>

                                <!-- External Inspection History Table -->
                                <h3 class="text-md font-bold text-blue-950 mb-4 border-b pb-2">External Inspection
                                    History
                                </h3>
                                <div class="mb-4 flex justify-between items-center">
                                    <button type="button" class="btn btn-sm bg-blue-950 text-white hover:bg-blue-900"
                                        onclick="showAddInspectionModal('External')">
                                        <span class="text-lg">+</span> Add External Inspection
                                    </button>
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn btn-sm bg-blue-950 text-white hover:bg-blue-900">
                                            ✓ Save changes
                                        </button>
                                        <button type="button"
                                            class="btn btn-sm bg-gray-300 text-gray-700 hover:bg-gray-400">
                                            ⊘ Cancel changes
                                        </button>
                                    </div>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="table w-full">
                                        <thead class="bg-blue-950 text-white">
                                            <tr>
                                                <th>Method</th>
                                                <th>Date</th>
                                                <th>General Condition</th>
                                                <th>Crack Finding Capability</th>
                                                <th>Corrosion Finding Capability</th>
                                                <th>Comments</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="external-history-tbody">
                                            <!-- Dynamic rows will be added here -->
                                            <tr class="text-gray-400 text-center">
                                                <td colspan="7">No inspection history records yet</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Thickness Tab -->
                            <div id="thickness-inspection-tab" class="inspection-tab hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">Nominal
                                                Thickness (mm)</span></label>
                                        {{ form.thickness_nominal_mm }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">Minimum
                                                Required Thickness (mm)</span></label>
                                        {{ form.thickness_minimum_required_mm }}
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">Measured
                                                Thickness (mm)</span></label>
                                        {{ form.thickness_measured_mm }}
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span
                                                class="label-text text-blue-950 font-semibold">Corrosion
                                                Rate (mm/year)</span></label>
                                        {{ form.corrosion_rate_mm_year }}
                                    </div>
                                </div>
                            </div>

                            <!-- Inspection Summary (visible on all tabs) -->
                            <div class="mt-8 pt-8 border-t-2 border-gray-200">
                                <h3 class="text-md font-bold text-blue-950 mb-4">Inspection Summary</h3>
                                <div class="form-control">
                                    {{ form.inspection_summary }}
                                </div>
                            </div>
                        </div>
                    </div> <!-- End of data-tab-content -->

                    <!-- CONSEQUENCE TAB CONTENT -->
                    <div id="consequence-tab-content" class="hidden p-4 bg-gray-50 rounded-lg border border-gray-200">

                        <!-- Validation Alert -->
                        <div id="cof-validation-alert" class="alert alert-warning shadow-lg mb-6 hidden">
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6"
                                    fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <div>
                                    <h3 class="font-bold">Missing Required Information</h3>
                                    <div class="text-xs" id="cof-missing-fields-list">
                                        <!-- Dynamic list of missing fields -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CALCULATION DETAILS (Collapsible) -->
                        <details
                            class="group mb-6 bg-white shadow-md rounded-lg border border-gray-200 overflow-hidden">
                            <summary
                                class="flex cursor-pointer items-center justify-between p-4 bg-gray-100 hover:bg-gray-200 transition-colors">
                                <h3 class="font-bold text-blue-950 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                                    </svg>
                                    Calculation Details / Verification
                                </h3>
                                <div class="text-gray-500 group-open:rotate-180 transition-transform duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </div>
                            </summary>
                            <div
                                class="p-4 bg-white text-xs border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                                <!-- Group 1: Fluid Props -->
                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">Fluid
                                        Properties</div>
                                    <div class="flex justify-between"><span>Fluid:</span> <span id="debug_fluid_name"
                                            class="font-mono bg-gray-100 px-1 rounded">-</span></div>
                                    <div class="flex justify-between"><span>MW:</span> <span id="debug_mw"
                                            class="font-mono bg-gray-100 px-1 rounded">-</span></div>
                                    <div class="flex justify-between"><span>Density (lb/ft³):</span> <span
                                            id="debug_density" class="font-mono bg-gray-100 px-1 rounded">-</span></div>
                                    <div class="flex justify-between"><span>NBP (°F):</span> <span id="debug_nbp"
                                            class="font-mono bg-gray-100 px-1 rounded">-</span></div>
                                    <div class="flex justify-between"><span>Amb. State:</span> <span
                                            id="debug_amb_state" class="font-mono bg-gray-100 px-1 rounded">-</span>
                                    </div>
                                    <div class="flex justify-between"><span>AIT (°F):</span> <span id="debug_ait"
                                            class="font-mono bg-gray-100 px-1 rounded">-</span></div>
                                </div>

                                <!-- Group 2: Process State -->
                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">Process
                                        State</div>
                                    <div class="flex justify-between"><span>Op. Phase:</span> <span id="debug_op_phase"
                                            class="font-mono bg-gray-100 px-1 rounded">-</span></div>
                                    <div class="flex justify-between"><span>Final Phase:</span> <span
                                            id="debug_final_phase" class="font-mono bg-gray-100 px-1 rounded">-</span>
                                    </div>
                                    <div class="flex justify-between"><span>Pressure (Ps):</span> <span id="debug_ps"
                                            class="font-mono bg-gray-100 px-1 rounded">-</span></div>
                                    <div class="flex justify-between"><span>Temp (°F):</span> <span id="debug_temp"
                                            class="font-mono bg-gray-100 px-1 rounded">-</span></div>
                                    <div class="flex justify-between"><span>Flow Regime:</span> <span id="debug_regime"
                                            class="font-mono bg-gray-100 px-1 rounded">-</span></div>
                                </div>

                                <!-- Group 3: Release Rates -->
                                <div class="space-y-1 md:col-span-2">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">Release
                                        Scenarios (Small / Med / Large / Rupture)</div>
                                    <div class="grid grid-cols-5 gap-1 text-center font-bold text-gray-500">
                                        <div class="text-left font-normal">Hole (in)</div>
                                        <div id="debug_d1">-</div>
                                        <div id="debug_d2">-</div>
                                        <div id="debug_d3">-</div>
                                        <div id="debug_d4">-</div>
                                    </div>
                                    <div class="grid grid-cols-5 gap-1 text-center">
                                        <div class="text-left">Wn (lb/s)</div>
                                        <div id="debug_wn1" class="font-mono bg-gray-50">-</div>
                                        <div id="debug_wn2" class="font-mono bg-gray-50">-</div>
                                        <div id="debug_wn3" class="font-mono bg-gray-50">-</div>
                                        <div id="debug_wn4" class="font-mono bg-gray-50">-</div>
                                    </div>
                                    <div class="grid grid-cols-5 gap-1 text-center">
                                        <div class="text-left">FactDI</div>
                                        <div id="debug_factdi" class="font-mono bg-gray-50 col-span-4 text-left pl-2">-
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-5 gap-1 text-center font-bold text-blue-800">
                                        <div class="text-left">RateN (lb/s)</div>
                                        <div id="debug_raten1" class="bg-blue-50">-</div>
                                        <div id="debug_raten2" class="bg-blue-50">-</div>
                                        <div id="debug_raten3" class="bg-blue-50">-</div>
                                        <div id="debug_raten4" class="bg-blue-50">-</div>
                                    </div>
                                    <div class="grid grid-cols-5 gap-1 text-center text-xs">
                                        <div class="text-left font-bold text-gray-500">Type</div>
                                        <div id="debug_rtype1" class="bg-gray-50">-</div>
                                        <div id="debug_rtype2" class="bg-gray-50">-</div>
                                        <div id="debug_rtype3" class="bg-gray-50">-</div>
                                        <div id="debug_rtype4" class="bg-gray-50">-</div>
                                    </div>
                                </div>

                                <!-- Group 4: Mass & Duration -->
                                <div class="space-y-1 md:col-span-2">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">Duration &
                                        Mass (First Scenario Detail)</div>
                                    <div class="flex justify-between"><span>Avail. Mass (lb):</span> <span
                                            id="debug_mass_avail" class="font-mono bg-gray-100 px-1 rounded">-</span>
                                    </div>
                                    <div class="grid grid-cols-5 gap-1 text-center">
                                        <div class="text-left">Duration (s)</div>
                                        <div id="debug_ld1" class="font-mono bg-gray-50">-</div>
                                        <div id="debug_ld2" class="font-mono bg-gray-50">-</div>
                                        <div id="debug_ld3" class="font-mono bg-gray-50">-</div>
                                        <div id="debug_ld4" class="font-mono bg-gray-50">-</div>
                                    </div>
                                    <div class="grid grid-cols-5 gap-1 text-center">
                                        <div class="text-left">Mass Rel (lb)</div>
                                        <div id="debug_massn1" class="font-mono bg-gray-50">-</div>
                                        <div id="debug_massn2" class="font-mono bg-gray-50">-</div>
                                        <div id="debug_massn3" class="font-mono bg-gray-50">-</div>
                                        <div id="debug_massn4" class="font-mono bg-gray-50">-</div>
                                    </div>
                                </div>

                                <!-- Group 5: Areas -->
                                <div class="space-y-1 md:col-span-2">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">Consequence
                                        Areas (ft²)</div>
                                    <div class="grid grid-cols-5 gap-1 text-center font-bold text-orange-600">
                                        <div class="text-left">CMD Area</div>
                                        <div id="debug_cmd1">-</div>
                                        <div id="debug_cmd2">-</div>
                                        <div id="debug_cmd3">-</div>
                                        <div id="debug_cmd4">-</div>
                                    </div>
                                    <div class="grid grid-cols-5 gap-1 text-center font-bold text-red-600">
                                        <div class="text-left">INJ Area</div>
                                        <div id="debug_inj1">-</div>
                                        <div id="debug_inj2">-</div>
                                        <div id="debug_inj3">-</div>
                                        <div id="debug_inj4">-</div>
                                    </div>
                                </div>

                            </div>
                        </details>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                            <!-- LEFT COLUMN: Data & Consequences -->
                            <div class="space-y-6">

                                <!-- DATA SECTION (Inputs) -->
                                <div class="card bg-white shadow-lg border-t-4 border-purple-900">
                                    <div
                                        class="text-lg font-bold mb-6 bg-blue-950 text-white py-2 px-4 -mx-6 -mt-6 rounded-t-lg">
                                        Data</div>
                                    <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">

                                        <!-- Equipment Cost -->
                                        <div class="form-control">
                                            <label class="label py-1"><span class="label-text">Equipment Replacement
                                                    Cost ($)</span></label>
                                            {{ form.equipment_cost_per_sqft }}
                                            <label class="label py-0"><span
                                                    class="label-text-alt text-gray-400">(Recommended Cost -
                                                    $120,000.00)</span></label>
                                        </div>

                                        <!-- Serious Injury Cost -->
                                        <div class="form-control">
                                            <label class="label py-1"><span class="label-text">Serious Injury Cost
                                                    ($)</span></label>
                                            {{ form.injury_cost_per_person }}
                                        </div>

                                        <!-- Enviro Cost -->
                                        <div class="form-control">
                                            <label class="label py-1"><span class="label-text">Environment Cleanup Cost
                                                    ($/bbl)</span></label>
                                            {{ form.environmental_cost_per_bbl }}
                                        </div>

                                        <!-- Production Cost -->
                                        <div>
                                            <label class="label py-1"><span class="label-text">Production
                                                    ($/day)</span></label>
                                            {{ form.production_cost_per_day }}
                                        </div>

                                        <!-- Production Impact (Mapped to Outage Multiplier/Days placeholder for now) -->
                                        <!-- User Image: Production Impact (%). Model: None. -->
                                        <!-- User Image: Shutdown (days). Model: outage_multiplier? -->
                                        <div class="form-control">
                                            <label class="label py-1"><span class="label-text">Outage Multiplier
                                                    (Shutdown Days)</span></label>
                                            {{ form.outage_multiplier }}
                                        </div>

                                    </div>
                                </div>

                                <!-- CONSEQUENCES SECTION (Results) -->
                                <div class="card bg-white shadow-lg border-t-4 border-purple-900">
                                    <div
                                        class="text-lg font-bold mb-6 bg-blue-950 text-white py-2 px-4 -mx-6 -mt-6 rounded-t-lg">
                                        Consequences</div>
                                    <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">

                                        <!-- Safety -->
                                        <div class="p-2 border rounded bg-gray-50">
                                            <div class="text-xs text-gray-500">Safety Consequence ($)</div>
                                            <div id="val_fc_inj" class="text-xl font-bold text-gray-800">0.00</div>
                                        </div>

                                        <!-- Environmental -->
                                        <div class="p-2 border rounded bg-gray-50">
                                            <div class="text-xs text-gray-500">Environmental Consequence ($)</div>
                                            <div id="val_fc_env" class="text-xl font-bold text-gray-800">0.00</div>
                                        </div>

                                        <!-- Business -->
                                        <div class="p-2 border rounded bg-gray-50">
                                            <div class="text-xs text-gray-500">Business Consequence ($)</div>
                                            <div id="val_fc_bus" class="text-xl font-bold text-gray-800">0.00</div>
                                            <div class="text-xs text-gray-400 mt-1">(Cmd + Prod)</div>
                                        </div>

                                        <!-- Bus & Env -->
                                        <div class="p-2 border rounded bg-gray-50">
                                            <div class="text-xs text-gray-500">Business & Environmental Consequence ($)
                                            </div>
                                            <div id="val_fc_bus_env" class="text-xl font-bold text-gray-800">0.00</div>
                                        </div>

                                        <!-- Total -->
                                        <div class="p-2 border rounded bg-purple-50 md:col-span-2">
                                            <div class="text-xs text-purple-800 font-bold">Total Consequence ($)</div>
                                            <div id="val_fc_total" class="text-2xl font-bold text-purple-900">0.00</div>
                                        </div>

                                        <!-- Consequence Area Summary (Hidden or Small) -->
                                        <div class="md:col-span-2 mt-2 pt-2 border-t border-gray-200">
                                            <div class="text-xs text-gray-400 mb-1">Area Details (ft²):</div>
                                            <div class="flex justify-between text-xs">
                                                <span>CMD Area: <strong id="val_final_cmd"
                                                        class="text-red-500">-</strong></span>
                                                <span>INJ Area: <strong id="val_final_inj"
                                                        class="text-orange-500">-</strong></span>
                                                <span>Start Rate: <strong id="val_wn1"
                                                        class="text-blue-500">-</strong></span>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>

                            <!-- RIGHT COLUMN: Chart -->
                            <div class="space-y-6">
                                <div class="card bg-white shadow-lg border-t-4 border-purple-900 h-full">
                                    <div class="bg-purple-900 text-white p-3 font-bold rounded-t-lg">CoF Chart</div>
                                    <div class="p-4 flex items-center justify-center h-full min-h-[400px]">
                                        <!-- Canvas for Chart.js -->
                                        <canvas id="cofChart"></canvas>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <!-- /CONSEQUENCE TAB CONTENT -->

                    <!-- PROBABILITY TAB CONTENT -->
                    <div id="probability-tab-content" class="hidden">

                        <!-- PROBABILITY SUMMARY PANEL (Always Visible) -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- Left: Damage Factor Summary Table -->
                            <div class="card bg-white shadow-md">
                                <div class="card-body p-4">
                                    <h4 class="font-bold text-lg text-purple-900 mb-4">Probability of Failure (1 to 4)
                                    </h4>
                                    <div class="grid grid-cols-2 gap-3">
                                        <!-- Metal Loss -->
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <span class="text-gray-700 font-medium">Metal Loss</span>
                                            <span id="pof_metal_loss"
                                                class="text-2xl font-bold text-orange-600">5</span>
                                        </div>

                                        <!-- Cracking -->
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <span class="text-gray-700 font-medium">Cracking</span>
                                            <span id="pof_cracking" class="text-2xl font-bold text-orange-600">3</span>
                                        </div>

                                        <!-- Mechanical -->
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <span class="text-gray-700 font-medium">Mechanical</span>
                                            <span id="pof_mechanical" class="text-2xl font-bold text-gray-400">0</span>
                                        </div>

                                        <!-- Metallurgical -->
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <span class="text-gray-700 font-medium">Metallurgical</span>
                                            <span id="pof_metallurgical"
                                                class="text-2xl font-bold text-gray-400">0</span>
                                        </div>

                                        <!-- External -->
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <span class="text-gray-700 font-medium">External</span>
                                            <span id="pof_external" class="text-2xl font-bold text-orange-600">3</span>
                                        </div>

                                        <!-- Other -->
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <span class="text-gray-700 font-medium">Other</span>
                                            <span id="pof_other" class="text-2xl font-bold text-gray-400">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: PoF Chart -->
                            <div class="card bg-white shadow-md">
                                <div class="card-body p-4">
                                    <h4 class="font-bold text-lg text-purple-900 mb-4">PoF Chart</h4>
                                    <div style="height: 250px; position: relative;">
                                        <canvas id="pof_chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- POF CALCULATION DETAILS (Collapsible) -->
                        <details
                            class="mb-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200 shadow-sm group">
                            <summary
                                class="cursor-pointer p-4 hover:bg-purple-100 rounded-lg transition-all duration-200 flex justify-between items-center">
                                <h3 class="font-bold text-purple-900 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                                    </svg>
                                    POF Calculation Details / Verification
                                </h3>
                                <div class="text-gray-500 group-open:rotate-180 transition-transform duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </div>
                            </summary>
                            <div
                                class="p-4 bg-white text-xs border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                                <!-- CRACKING MECHANISMS -->
                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">Caustic SCC
                                    </div>
                                    <div class="flex justify-between"><span>Susceptibility:</span> <span
                                            id="pof_debug_caustic_susc"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>SVI:</span> <span id="pof_debug_caustic_svi"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Inspection:</span> <span
                                            id="pof_debug_caustic_insp"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Base DF:</span> <span
                                            id="pof_debug_caustic_base_df"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between font-bold"><span>Final DF:</span> <span
                                            id="pof_debug_caustic_final_df"
                                            class="font-mono bg-blue-100 px-1 rounded text-blue-900">--</span></div>
                                </div>

                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">Amine SCC
                                    </div>
                                    <div class="flex justify-between"><span>Susceptibility:</span> <span
                                            id="pof_debug_amine_susc"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>SVI:</span> <span id="pof_debug_amine_svi"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Inspection:</span> <span
                                            id="pof_debug_amine_insp"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Base DF:</span> <span
                                            id="pof_debug_amine_base_df"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between font-bold"><span>Final DF:</span> <span
                                            id="pof_debug_amine_final_df"
                                            class="font-mono bg-blue-100 px-1 rounded text-blue-900">--</span></div>
                                </div>

                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">SSC</div>
                                    <div class="flex justify-between"><span>Susceptibility:</span> <span
                                            id="pof_debug_ssc_susc" class="font-mono bg-gray-100 px-1 rounded">--</span>
                                    </div>
                                    <div class="flex justify-between"><span>SVI:</span> <span id="pof_debug_ssc_svi"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Inspection:</span> <span
                                            id="pof_debug_ssc_insp" class="font-mono bg-gray-100 px-1 rounded">--</span>
                                    </div>
                                    <div class="flex justify-between"><span>Base DF:</span> <span
                                            id="pof_debug_ssc_base_df"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between font-bold"><span>Final DF:</span> <span
                                            id="pof_debug_ssc_final_df"
                                            class="font-mono bg-blue-100 px-1 rounded text-blue-900">--</span></div>
                                </div>

                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">HIC/SOHIC
                                    </div>
                                    <div class="flex justify-between"><span>Susceptibility:</span> <span
                                            id="pof_debug_hic_susc" class="font-mono bg-gray-100 px-1 rounded">--</span>
                                    </div>
                                    <div class="flex justify-between"><span>SVI:</span> <span id="pof_debug_hic_svi"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Inspection:</span> <span
                                            id="pof_debug_hic_insp" class="font-mono bg-gray-100 px-1 rounded">--</span>
                                    </div>
                                    <div class="flex justify-between"><span>Base DF:</span> <span
                                            id="pof_debug_hic_base_df"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between font-bold"><span>Final DF:</span> <span
                                            id="pof_debug_hic_final_df"
                                            class="font-mono bg-blue-100 px-1 rounded text-blue-900">--</span></div>
                                </div>

                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">ACSCC</div>
                                    <div class="flex justify-between"><span>Susceptibility:</span> <span
                                            id="pof_debug_acscc_susc"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>SVI:</span> <span id="pof_debug_acscc_svi"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Inspection:</span> <span
                                            id="pof_debug_acscc_insp"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Base DF:</span> <span
                                            id="pof_debug_acscc_base_df"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between font-bold"><span>Final DF:</span> <span
                                            id="pof_debug_acscc_final_df"
                                            class="font-mono bg-blue-100 px-1 rounded text-blue-900">--</span></div>
                                </div>

                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">PASCC</div>
                                    <div class="flex justify-between"><span>Susceptibility:</span> <span
                                            id="pof_debug_pascc_susc"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>SVI:</span> <span id="pof_debug_pascc_svi"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Inspection:</span> <span
                                            id="pof_debug_pascc_insp"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Base DF:</span> <span
                                            id="pof_debug_pascc_base_df"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between font-bold"><span>Final DF:</span> <span
                                            id="pof_debug_pascc_final_df"
                                            class="font-mono bg-blue-100 px-1 rounded text-blue-900">--</span></div>
                                </div>

                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">ClSCC</div>
                                    <div class="flex justify-between"><span>Susceptibility:</span> <span
                                            id="pof_debug_clscc_susc"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>SVI:</span> <span id="pof_debug_clscc_svi"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Inspection:</span> <span
                                            id="pof_debug_clscc_insp"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Base DF:</span> <span
                                            id="pof_debug_clscc_base_df"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between font-bold"><span>Final DF:</span> <span
                                            id="pof_debug_clscc_final_df"
                                            class="font-mono bg-blue-100 px-1 rounded text-blue-900">--</span></div>
                                </div>

                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">HSC-HF</div>
                                    <div class="flex justify-between"><span>Susceptibility:</span> <span
                                            id="pof_debug_hschf_susc"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>SVI:</span> <span id="pof_debug_hschf_svi"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Inspection:</span> <span
                                            id="pof_debug_hschf_insp"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between"><span>Base DF:</span> <span
                                            id="pof_debug_hschf_base_df"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between font-bold"><span>Final DF:</span> <span
                                            id="pof_debug_hschf_final_df"
                                            class="font-mono bg-blue-100 px-1 rounded text-blue-900">--</span></div>
                                </div>

                                <!-- THINNING MECHANISMS -->
                                <div class="space-y-1">
                                    <div class="font-bold text-blue-900 border-b border-gray-100 mb-1 pb-1">CO2
                                        Corrosion</div>
                                    <div class="flex justify-between"><span>Rate (mpy):</span> <span
                                            id="pof_debug_co2_rate" class="font-mono bg-gray-100 px-1 rounded">--</span>
                                    </div>
                                    <div class="flex justify-between"><span>Fugacity (bar):</span> <span
                                            id="pof_debug_co2_fugacity"
                                            class="font-mono bg-gray-100 px-1 rounded">--</span></div>
                                    <div class="flex justify-between font-bold"><span>DF:</span> <span
                                            id="pof_debug_co2_df"
                                            class="font-mono bg-blue-100 px-1 rounded text-blue-900">--</span></div>
                                </div>

                            </div>
                        </details>

                        <!-- Sub-tabs for Probability -->
                        <div class="flex gap-2 mb-6 bg-gray-100 p-2 rounded-lg border border-gray-200">
                            <button type="button" class="btn btn-sm bg-blue-950 text-white font-bold shadow-md"
                                onclick="showProbSubTab('gff', this)">GFF</button>
                            <button type="button"
                                class="btn btn-sm bg-gray-200 text-gray-700 font-normal hover:bg-gray-300"
                                onclick="showProbSubTab('fms', this)">FMS</button>
                            <button type="button"
                                class="btn btn-sm bg-gray-200 text-gray-700 font-normal hover:bg-gray-300"
                                onclick="showProbSubTab('cracking', this)">Cracking (SCC)</button>
                            <button type="button"
                                class="btn btn-sm bg-gray-200 text-gray-700 font-normal hover:bg-gray-300"
                                onclick="showProbSubTab('thinning', this)">Thinning (Metal Loss)</button>
                            <button type="button"
                                class="btn btn-sm bg-gray-200 text-gray-700 font-normal hover:bg-gray-300"
                                onclick="showProbSubTab('external', this)">External Damage</button>
                            <button type="button"
                                class="btn btn-sm bg-gray-200 text-gray-700 font-normal hover:bg-gray-300"
                                onclick="showProbSubTab('brittle', this)">Brittle Fracture</button>
                            <button type="button"
                                class="btn btn-sm bg-gray-200 text-gray-700 font-normal hover:bg-gray-300"
                                onclick="showProbSubTab('htha', this)">HTHA</button>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">

                            <!-- GFF Section -->
                            <div id="prob-subtab-gff">
                                {% include 'dashboard/includes/calculations/gff_fragment.html' %}
                            </div>

                            <!-- FMS Section -->
                            <div id="prob-subtab-fms" class="hidden">
                                {% include 'dashboard/includes/calculations/fms_fragment.html' %}
                            </div>

                            <!-- Cracking Section -->
                            <div id="prob-subtab-cracking" class="hidden">
                                <h2 class="text-xl font-bold text-blue-900 mb-4 pb-2 border-b">Stress Corrosion Cracking
                                    (SCC)</h2>
                                <p class="text-sm text-gray-500 mb-6">
                                    Configure active cracking mechanisms based on API 581.
                                </p>
                                {% include 'dashboard/includes/calculations/scc_fragments.html' %}
                            </div>

                            <!-- Thinning Section -->
                            <div id="prob-subtab-thinning" class="hidden">
                                <h2 class="text-xl font-bold text-blue-900 mb-4 pb-2 border-b">Thinning (Metal Loss)
                                </h2>
                                <p class="text-sm text-gray-500 mb-6">
                                    Configure general and localized corrosion mechanisms (Acid, Amine, CO2, etc.).
                                </p>
                                {% include 'dashboard/includes/calculations/thinning_fragments.html' %}
                            </div>

                            <!-- External Damage Section -->
                            <div id="prob-subtab-external" class="hidden">
                                <h2 class="text-xl font-bold text-blue-900 mb-4 pb-2 border-b">External Damage</h2>
                                <p class="text-sm text-gray-500 mb-6">
                                    Configure external damage mechanisms including CUI and Atmospheric Corrosion.
                                </p>
                                {% include 'dashboard/includes/calculations/external_damage_fragments.html' %}
                            </div>

                            <!-- Brittle Fracture Section -->
                            <div id="prob-subtab-brittle" class="hidden">
                                <h2 class="text-xl font-bold text-blue-900 mb-4 pb-2 border-b">Brittle Fracture</h2>
                                <p class="text-sm text-gray-500 mb-6">
                                    Calculate Brittle Fracture damage factor for low-alloy and carbon steel (API 581
                                    Part 2, 2.E).
                                </p>
                                {% include 'dashboard/includes/calculations/brittle_fracture_fragments.html' %}
                            </div>

                            <!-- HTHA Section -->
                            <div id="prob-subtab-htha" class="hidden">
                                <h2 class="text-xl font-bold text-blue-900 mb-4 pb-2 border-b">High Temperature Hydrogen
                                    Attack (HTHA)</h2>
                                <p class="text-sm text-gray-500 mb-6">
                                    Calculate HTHA susceptibility and damage factor per API 581 Part 2, Section 6.
                                </p>
                                {% include 'dashboard/includes/calculations/htha_fragments.html' %}
                            </div>

                        </div>
                    </div>

                    <!-- RISK TAB CONTENT -->
                    <div id="risk-tab-content" class="hidden p-6">

                        <!-- Risk Matrix Configuration Selector -->
                        <div class="card bg-white shadow-md border-l-4 border-purple-900 mb-6">
                            <div class="card-body p-4">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                                        </path>
                                    </svg>
                                    Matrix Configuration
                                </h4>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                                    <!-- Computation Type -->
                                    <div>
                                        <label class="label pb-1">
                                            <span class="label-text font-semibold text-gray-700">Computation Type</span>
                                        </label>
                                        <div class="space-y-2">
                                            <label
                                                class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                <input type="radio" name="computation_type" value="qualitative"
                                                    class="radio radio-sm radio-primary">
                                                <span class="text-sm">Qualitative</span>
                                            </label>
                                            <label
                                                class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                <input type="radio" name="computation_type" value="semi_quantitative"
                                                    class="radio radio-sm radio-primary">
                                                <span class="text-sm">Semi-Quantitative</span>
                                            </label>
                                            <label
                                                class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                <input type="radio" name="computation_type" value="quantitative"
                                                    class="radio radio-sm radio-primary" checked>
                                                <span class="text-sm">Quantitative</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- CA/FC Toggle -->
                                    <div>
                                        <label class="label pb-1">
                                            <span class="label-text font-semibold text-gray-700">Consequence
                                                Metric</span>
                                        </label>
                                        <div class="space-y-2">
                                            <label
                                                class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                <input type="radio" name="consequence_metric" value="ca"
                                                    class="radio radio-sm radio-secondary">
                                                <span class="text-sm">CA (Consequence Area)</span>
                                            </label>
                                            <label
                                                class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                <input type="radio" name="consequence_metric" value="fc"
                                                    class="radio radio-sm radio-secondary" checked>
                                                <span class="text-sm">FC (Financial Consequence)</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Pf/Df Toggle -->
                                    <div>
                                        <label class="label pb-1">
                                            <span class="label-text font-semibold text-gray-700">Probability
                                                Metric</span>
                                        </label>
                                        <div class="space-y-2">
                                            <label
                                                class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                <input type="radio" name="probability_metric" value="pf"
                                                    class="radio radio-sm radio-accent" checked>
                                                <span class="text-sm">Pf (Probability Factor)</span>
                                            </label>
                                            <label
                                                class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                <input type="radio" name="probability_metric" value="df"
                                                    class="radio radio-sm radio-accent">
                                                <span class="text-sm">Df (Damage Factor)</span>
                                            </label>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <!-- Current Values Summary -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <!-- POF Card -->
                            <div class="card bg-blue-50 shadow-md border-t-4 border-blue-900">
                                <div class="card-body p-4">
                                    <h4 class="font-bold text-sm text-gray-600 mb-2">Current POF</h4>
                                    <div id="risk_pof_value" class="text-5xl font-bold text-blue-900">--</div>
                                    <div id="risk_pof_label" class="text-xs text-gray-500 mt-1">Level -- </div>
                                </div>
                            </div>

                            <!-- COF Card -->
                            <div class="card bg-purple-50 shadow-md border-t-4 border-purple-900">
                                <div class="card-body p-4">
                                    <h4 class="font-bold text-sm text-gray-600 mb-2">Current COF</h4>
                                    <div id="risk_cof_category" class="text-5xl font-bold text-purple-900">--</div>
                                    <div id="risk_cof_label" class="text-xs text-gray-500 mt-1">Category --</div>
                                </div>
                            </div>

                            <!-- Risk Level Card -->
                            <div class="card shadow-md border-t-4" id="risk_level_card">
                                <div class="card-body p-4">
                                    <h4 class="font-bold text-sm text-gray-600 mb-2">Risk Level</h4>
                                    <div id="risk_level_value" class="text-2xl font-bold">--</div>
                                    <div id="risk_priority" class="text-xs text-gray-500 mt-1">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Matrix -->
                        <div class="card bg-white shadow-lg">
                            <div class="card-body p-6">
                                <h3 class="font-bold text-xl text-blue-900 mb-4">Risk Matrix (API 580/581)</h3>

                                <!-- Matrix Grid -->
                                <div class="mb-6" style="display: flex; justify-content: center; padding: 20px;">
                                    <div id="risk-matrix-grid"
                                        style="display: grid !important; grid-template-columns: 80px repeat(5, 90px) !important; grid-template-rows: repeat(5, 90px) 60px !important; gap: 2px !important; background: #e5e7eb; padding: 2px; border: 1px solid #d1d5db;">
                                        <!-- Grid cells will be generated by JavaScript -->
                                    </div>
                                </div>


                                <!-- Legend -->
                                <div class="flex flex-wrap justify-center gap-4 mb-4">
                                    <div class="flex items-center gap-2">
                                        <div
                                            style="width: 28px; height: 28px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">
                                        </div>
                                        <span class="text-sm font-semibold text-gray-700">Low Risk</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div
                                            style="width: 28px; height: 28px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">
                                        </div>
                                        <span class="text-sm font-semibold text-gray-700">Medium Risk</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div
                                            style="width: 28px; height: 28px; background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">
                                        </div>
                                        <span class="text-sm font-semibold text-gray-700">Medium-High Risk</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div
                                            style="width: 28px; height: 28px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">
                                        </div>
                                        <span class="text-sm font-semibold text-gray-700">High Risk</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Collapsible Details Section -->
                        <div class="collapse collapse-arrow bg-base-200 mt-6">
                            <input type="checkbox" />
                            <div class="collapse-title text-xl font-medium">
                                📊 Detailed Risk Calculation Breakdown
                            </div>
                            <div class="collapse-content">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">

                                    <!-- POF Breakdown -->
                                    <div class="card bg-white shadow">
                                        <div class="card-body p-4">
                                            <h4 class="font-bold text-blue-900 mb-3">Probability of Failure (POF)
                                                Details</h4>
                                            <div class="overflow-x-auto">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Damage Mechanism</th>
                                                            <th>POF Level</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Metal Loss (Thinning)</td>
                                                            <td><span id="detail_pof_metal_loss"
                                                                    class="badge badge-primary">--</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Cracking (SCC)</td>
                                                            <td><span id="detail_pof_cracking"
                                                                    class="badge badge-primary">--</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td>External Damage</td>
                                                            <td><span id="detail_pof_external"
                                                                    class="badge badge-primary">--</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Metallurgical (HTHA/Brittle)</td>
                                                            <td><span id="detail_pof_metallurgical"
                                                                    class="badge badge-primary">--</span></td>
                                                        </tr>
                                                        <tr class="font-bold bg-blue-50">
                                                            <td>Maximum POF (Final)</td>
                                                            <td><span id="detail_pof_final"
                                                                    class="badge badge-info badge-lg">--</span></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-2">
                                                <strong>Note:</strong> Final POF is the maximum value across all damage
                                                mechanisms.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- COF Breakdown -->
                                    <div class="card bg-white shadow">
                                        <div class="card-body p-4">
                                            <h4 class="font-bold text-purple-900 mb-3">Consequence of Failure (COF)
                                                Details</h4>
                                            <div class="overflow-x-auto">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Consequence Area</th>
                                                            <th>Value</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Flammable Consequences</td>
                                                            <td id="detail_fc_flam">$0</td>
                                                        </tr>
                                                        <tr>
                                                            <td>Toxic Consequences</td>
                                                            <td id="detail_fc_toxic">$0</td>
                                                        </tr>
                                                        <tr>
                                                            <td>Injury Consequences</td>
                                                            <td id="detail_fc_inj">$0</td>
                                                        </tr>
                                                        <tr>
                                                            <td>Environmental Consequences</td>
                                                            <td id="detail_fc_env">$0</td>
                                                        </tr>
                                                        <tr class="font-bold bg-purple-50">
                                                            <td>Total Financial Consequence</td>
                                                            <td id="detail_fc_total" class="text-lg">$0</td>
                                                        </tr>
                                                        <tr class="font-bold bg-purple-100">
                                                            <td>COF Category</td>
                                                            <td><span id="detail_cof_category"
                                                                    class="badge badge-secondary badge-lg">--</span>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-2">
                                                <strong>Categories:</strong> A (&lt;$10K), B ($10K-$100K), C
                                                ($100K-$1M), D ($1M-$10M), E (&gt;$10M)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- /RISK TAB CONTENT -->

                    <!-- INSPECTION PLANNING TAB CONTENT -->
                    <div id="inspection-planning-tab-content" class="hidden p-6">
                        <div class="card bg-white shadow-lg border-t-4 border-blue-600">
                            <div class="card-body">
                                <h2 class="card-title text-blue-900 mb-6">Inspection Planning & Interval Analysis</h2>

                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                                    <!-- Configuration Panel -->
                                    <div class="space-y-6">
                                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                            <h3 class="font-bold text-blue-800 mb-3 border-b border-blue-200 pb-2">
                                                Configuration</h3>

                                            <div class="form-control mb-4">
                                                <label class="label">
                                                    <span class="label-text font-semibold">Target Maximum Damage
                                                        Factor</span>
                                                    <span class="label-text-alt text-gray-500"
                                                        data-tip="API 581 Limit">?</span>
                                                </label>
                                                <input type="number" id="inp_target_max_df"
                                                    class="input input-bordered w-full font-mono text-lg" value="100"
                                                    min="1" step="10">
                                                <label class="label">
                                                    <span class="label-text-alt text-gray-500">Typical Limits: 100
                                                        (Med), 1000 (High)</span>
                                                </label>
                                            </div>

                                            <div class="alert alert-info shadow-sm text-xs">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                    class="stroke-current shrink-0 w-6 h-6">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                                    </path>
                                                </svg>
                                                <div>
                                                    <h3 class="font-bold">Total DF Calculation</h3>
                                                    <div>Sum of all active damage mechanisms projected over time (API
                                                        581 principle).</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Results Card -->
                                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-center">
                                            <h3 class="font-bold text-gray-600 mb-2">Recommended Inspection Date</h3>
                                            <div id="insp_res_date" class="text-3xl font-bold text-blue-900 mb-1">--
                                            </div>
                                            <div id="insp_res_time_remaining" class="text-lg font-bold text-gray-500">
                                                Not Calculated</div>
                                            <div class="mt-4 pt-3 border-t border-gray-200 text-xs text-gray-400">
                                                Projected DF at date: <span id="insp_res_proj_df"
                                                    class="font-mono text-gray-600 font-bold">--</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Chart Area -->
                                    <div class="lg:col-span-2">
                                        <div class="w-full relative" style="height: 50vh;">
                                            <canvas id="inspection_chart"></canvas>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /INSPECTION PLANNING TAB CONTENT -->

                    <script>
                        function showProbSubTab(tabName, btn) {
                            // Hide contents
                            document.getElementById('prob-subtab-cracking').classList.add('hidden');
                            document.getElementById('prob-subtab-thinning').classList.add('hidden');
                            document.getElementById('prob-subtab-external').classList.add('hidden');
                            document.getElementById('prob-subtab-brittle').classList.add('hidden');

                            // Show selected
                            document.getElementById(`prob-subtab-${tabName}`).classList.remove('hidden');

                            // Show selected
                            document.getElementById(`prob-subtab-${tabName}`).classList.remove('hidden');

                            // Update Buttons
                            const buttons = btn.parentElement.querySelectorAll('button');
                            buttons.forEach(b => {
                                if (!b.disabled) {
                                    b.classList.remove('bg-blue-950', 'text-white', 'font-bold', 'shadow-md');
                                    b.classList.add('bg-gray-200', 'text-gray-700', 'font-normal');
                                }
                            });

                            btn.classList.remove('bg-gray-200', 'text-gray-700', 'font-normal');
                            btn.classList.add('bg-blue-950', 'text-white', 'font-bold', 'shadow-md');
                        }
                    </script>



                </form>
            </div>
    </div>

    <!-- Inspection History Modal -->
    <dialog id="inspection_modal" class="modal">
        <form method="dialog" class="modal-box w-11/12 max-w-5xl bg-white text-blue-950">
            <h3 class="font-bold text-lg mb-4">Add Inspection Record</h3>

            <input type="hidden" id="modal_inspection_type" name="inspection_type">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label"><span class="label-text">Date</span></label>
                    <input type="date" id="modal_date" class="input input-bordered w-full" required>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Method</span></label>
                    <input type="text" id="modal_method" class="input input-bordered w-full" readonly>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label"><span class="label-text">Lining Quality / External Coating
                            Quality</span></label>
                    <select id="modal_lining_quality" class="select select-bordered w-full">
                        <option value="">-- Select --</option>
                        <option value="Poor">Poor</option>
                        <option value="Fair">Fair</option>
                        <option value="Good">Good</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Average">Average</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">General Condition</span></label>
                    <select id="modal_general_condition" class="select select-bordered w-full">
                        <option value="Poor">Poor</option>
                        <option value="Fair">Fair</option>
                        <option value="Good">Good</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Average">Average</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label"><span class="label-text">Crack Finding Capability</span></label>
                    <select id="modal_crack_finding" class="select select-bordered w-full">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Corrosion Finding Capability</span></label>
                    <select id="modal_corrosion_finding" class="select select-bordered w-full">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="Medium-High">Medium-High</option>
                        <option value="High">High</option>
                    </select>
                </div>
            </div>

            <div class="form-control mb-6">
                <label class="label"><span class="label-text">Comments</span></label>
                <textarea id="modal_comments" class="textarea textarea-bordered h-24"></textarea>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost"
                    onclick="document.getElementById('inspection_modal').close()">Cancel</button>
                <button type="button" class="btn bg-blue-950 text-white hover:bg-blue-900"
                    onclick="saveInspectionHistory()">Save</button>
            </div>
        </form>
    </dialog>

    <script>
        // Store component ID for AJAX requests
        const COMPONENT_ID = "{{ component.id|default:'' }}";

        // Show modal for adding inspection
        function showAddInspectionModal(type) {
            if (!COMPONENT_ID) {
                alert("Please save the component before adding inspection history.");
                return;
            }

            document.getElementById('modal_inspection_type').value = type;
            document.getElementById('modal_method').value = type + ' Visual'; // Default description
            document.getElementById('modal_date').valueAsDate = new Date();

            document.getElementById('inspection_modal').showModal();
        }

        // Save inspection history via AJAX
        function saveInspectionHistory() {
            const data = {
                component_id: COMPONENT_ID,
                inspection_type: document.getElementById('modal_method').value,
                date: document.getElementById('modal_date').value,
                lining_quality: document.getElementById('modal_lining_quality').value,
                general_condition: document.getElementById('modal_general_condition').value,
                crack_finding_capability: document.getElementById('modal_crack_finding').value,
                corrosion_finding_capability: document.getElementById('modal_corrosion_finding').value,
                comments: document.getElementById('modal_comments').value
            };

            fetch("{% url 'add_inspection_history' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById('inspection_modal').close();
                        loadInspectionHistory(); // Reload tables
                    } else {
                        alert('Error saving inspection: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while saving.');
                });
        }

        // Delete inspection history via AJAX
        function deleteInspectionHistory(id) {
            if (!confirm('Are you sure you want to delete this inspection record?')) return;

            fetch(`/dashboard/components/inspection-history/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        loadInspectionHistory();
                    } else {
                        alert('Error deleting record.');
                    }
                });
        }

        // Load inspection history
        function loadInspectionHistory() {
            if (!COMPONENT_ID) return;

            fetch(`/dashboard/components/${COMPONENT_ID}/inspection-history/`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const internalTbody = document.getElementById('internal-history-tbody');
                        const externalTbody = document.getElementById('external-history-tbody');

                        internalTbody.innerHTML = '';
                        externalTbody.innerHTML = '';

                        let internalCount = 0;
                        let externalCount = 0;

                        result.data.forEach(item => {
                            const row = `
                            <tr class="hover">
                                <td>${item.inspection_type}</td>
                                <td>${item.date}</td>
                                <td>${item.lining_quality || '-'}</td>
                                <td>${item.general_condition}</td>
                                <td>${item.crack_finding_capability}</td>
                                <td>${item.corrosion_finding_capability}</td>
                                <td class="truncate max-w-xs" title="${item.comments || ''}">${item.comments || '-'}</td>
                                <td>
                                    <button type="button" class="btn btn-xs btn-error text-white" onclick="deleteInspectionHistory(${item.id})">Delete</button>
                                </td>
                            </tr>
                        `;

                            if (item.inspection_type.includes('Internal')) {
                                internalTbody.innerHTML += row;
                                internalCount++;
                            } else {
                                externalTbody.innerHTML += row;
                                externalCount++;
                            }
                        });

                        if (internalCount === 0) internalTbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-400">No records found</td></tr>';
                        if (externalCount === 0) externalTbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-400">No records found</td></tr>';
                    }
                });
        }

        // Load history on page load
        document.addEventListener('DOMContentLoaded', loadInspectionHistory);
    </script>



    <!-- END MAIN CONTENT -->


    <script type="module" src="{% static 'dashboard/js/cof_dashboard.js' %}"></script>
    <!-- Chart.js for PoF visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="{% static 'dashboard/js/calculations/formula_app_adapter.js' %}"></script>
    <script src="{% static 'dashboard/js/calculations/htha.js' %}"></script>
    <script src="{% static 'dashboard/js/calculations/risk_matrix.js' %}"></script>
    <!-- OLD: Commented out to prevent conflicts with formula_app_adapter.js -->
    <!-- <script src="{% static 'dashboard/js/calculations/scc_calculations.js' %}"></script> -->
    <script>
        function openMainTab(evt, tabName) {
            // Hide all tab contents
            document.getElementById('data-tab-content').classList.add('hidden');
            document.getElementById('consequence-tab-content').classList.add('hidden');
            document.getElementById('probability-tab-content').classList.add('hidden');
            document.getElementById('risk-tab-content').classList.add('hidden');
            document.getElementById('inspection-planning-tab-content').classList.add('hidden');

            // Show the clicked tab content
            document.getElementById(tabName + '-tab-content').classList.remove('hidden');

            // Initialize Risk Matrix if opening risk tab
            if (tabName === 'risk') {
                setTimeout(() => {
                    if (!window.riskMatrixInitialized) {
                        console.log('[Risk Matrix] First time init...');
                        initRiskMatrix();
                        window.riskMatrixInitialized = true;
                    }
                    updateRiskMatrix();
                }, 100);
            }
            // Initialize Inspection Chart if opening inspection planning tab
            if (tabName === 'inspection-planning') {
                setTimeout(() => {
                    if (window.initInspectionPlanning) {
                        console.log('[Inspection Planning] Initializing...');
                        window.initInspectionPlanning();
                    } else {
                        console.error('[Inspection Planning] init function not found');
                    }
                }, 100);
            }

            // Deactivate all tabs
            const tabs = document.querySelectorAll('.tabs > .tab');
            tabs.forEach(t => {
                t.classList.remove('tab-active', 'text-blue-950', 'font-semibold');
                t.classList.add('text-gray-500');
            });

            // Activate clicked
            evt.currentTarget.classList.add('tab-active', 'text-blue-950', 'font-semibold');
            evt.currentTarget.classList.remove('text-gray-500');
        }

        function showSubTab(tabName, clickedButton) {
            // Hide all sections
            document.getElementById('design-section').classList.add('hidden');
            document.getElementById('operating-section').classList.add('hidden');
            document.getElementById('inspection-section').classList.add('hidden');

            // Show selected section
            document.getElementById(tabName + '-section').classList.remove('hidden');

            // Update button styles
            const buttons = document.querySelectorAll('[onclick^="showSubTab"]');
            buttons.forEach(btn => {
                btn.classList.remove('bg-blue-950', 'hover:bg-blue-900', 'text-white', 'shadow-md', 'font-semibold');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            });

            // Highlight clicked button
            if (clickedButton) {
                clickedButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                clickedButton.classList.add('bg-blue-950', 'hover:bg-blue-900', 'text-white', 'shadow-md', 'font-semibold');
            }
        }

        function showProbSubTab(tabName, clickedButton) {
            // Hide all probability sub-tabs
            const probSubTabs = [
                'prob-subtab-gff',
                'prob-subtab-fms',
                'prob-subtab-cracking',
                'prob-subtab-thinning',
                'prob-subtab-external',
                'prob-subtab-brittle',
                'prob-subtab-htha'
            ];

            probSubTabs.forEach(tabId => {
                const element = document.getElementById(tabId);
                if (element) element.classList.add('hidden');
            });

            // Show selected sub-tab
            const selectedTab = document.getElementById('prob-subtab-' + tabName);
            if (selectedTab) selectedTab.classList.remove('hidden');

            // Update button styles
            const buttons = document.querySelectorAll('[onclick^="showProbSubTab"]');
            buttons.forEach(btn => {
                btn.classList.remove('bg-blue-950', 'text-white', 'font-bold', 'shadow-md');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'font-normal', 'hover:bg-gray-300');
            });

            // Highlight clicked button
            if (clickedButton) {
                clickedButton.classList.remove('bg-gray-200', 'text-gray-700', 'font-normal', 'hover:bg-gray-300');
                clickedButton.classList.add('bg-blue-950', 'text-white', 'font-bold', 'shadow-md');
            }
        }

        function showInspectionTab(tabName, clickedButton) {
            // Hide all inspection tabs
            document.querySelectorAll('.inspection-tab').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Show selected tab
            document.getElementById(tabName + '-inspection-tab').classList.remove('hidden');

            // Update button styles within the inspection section
            const container = clickedButton.parentElement;
            const buttons = container.querySelectorAll('button');

            buttons.forEach(btn => {
                btn.classList.remove('bg-blue-950', 'text-white', 'font-semibold');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });

            // Highlight clicked button
            clickedButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            clickedButton.classList.add('bg-blue-950', 'text-white', 'font-semibold');
        }

        // Toggle Liquid/Vapor Release Rate sections based on Stored Phase
        document.addEventListener('DOMContentLoaded', function () {
            const storedPhaseSelect = document.getElementById('id_stored_phase');
            const liquidSection = document.getElementById('liquid-release-section');
            const vaporSection = document.getElementById('vapor-release-section');

            function toggleReleaseRateSections() {
                const selectedPhase = storedPhaseSelect.value;

                if (selectedPhase === 'Liquid') {
                    liquidSection.classList.remove('hidden');
                    vaporSection.classList.add('hidden');
                } else if (selectedPhase === 'Vapor') {
                    vaporSection.classList.remove('hidden');
                    liquidSection.classList.add('hidden');
                } else {
                    liquidSection.classList.add('hidden');
                    vaporSection.classList.add('hidden');
                }
            }

            // Initial check on page load
            if (storedPhaseSelect) {
                toggleReleaseRateSections();

                // Add event listener for changes
                storedPhaseSelect.addEventListener('change', toggleReleaseRateSections);
            }
        });
    </script>

    </main>
</div>
</div>

<!-- Material Selection Modal -->
<dialog id="materialModal" class="modal">
    <div class="modal-box w-11/12 max-w-3xl">
        <h3 class="font-bold text-lg mb-4">Select Material of Construction (API 581 Table 4.16)</h3>

        <!-- Search Box -->
        <input type="text" id="materialSearch" placeholder="Search materials..."
            class="input input-bordered w-full mb-4">

        <!-- Materials Table -->
        <div class="overflow-y-auto max-h-96">
            <table class="table table-zebra w-full">
                <thead class="bg-purple-800 text-white sticky top-0">
                    <tr>
                        <th class="w-12 text-center">#</th>
                        <th>Material Name</th>
                        <th class="text-center">Category</th>
                        <th class="text-center">Cost Factor</th>
                        <th class="text-center w-24"></th>
                    </tr>
                </thead>
                <tbody id="materialTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-end">
            <button type="button" onclick="materialModal.close()" class="btn btn-outline">Cancel</button>
        </div>
    </div>
    </div>
</dialog>

<script type="module">
    import { MaterialCostFactors } from '{% static "formula_app/data/cof/table4_15_16.js" %}';

    const materialModal = document.getElementById('materialModal');
    const materialSearch = document.getElementById('materialSearch');
    const materialTableBody = document.getElementById('materialTableBody');
    const materialConstructionSelect = document.getElementById('id_material_construction');
    const rbixMaterialDisplay = document.getElementById('rbixMaterialDisplay');

    // Find the "Select Material" button
    const selectMaterialButton = document.getElementById('btnSelectMaterial');

    // Populate material table
    function populateMaterialTable(filter = '') {
        materialTableBody.innerHTML = '';

        Object.entries(MaterialCostFactors)
            .filter(([name]) => name.toLowerCase().includes(filter.toLowerCase()))
            .sort(([a], [b]) => a.localeCompare(b))
            .forEach(([materialName, costFactor], index) => {
                // Helper to categorize materials
                let category = 'Other';
                if (materialName.includes('Steel') || materialName === 'Carbon Steel') category = 'Carbon Steel';
                else if (materialName.includes('SS')) category = 'Stainless Steel';
                else if (materialName.includes('Alloy')) category = 'Alloy';
                else if (materialName.includes('Cu/Ni')) category = 'Copper Alloy';
                else if (materialName.includes('lined') || materialName.includes('coating')) category = 'Lined/Coated';

                const row = document.createElement('tr');
                row.className = 'hover cursor-pointer';
                row.innerHTML = `
                    <td class="text-center text-gray-500 text-sm">${index + 1}</td>
                    <td class="font-medium">${materialName}</td>
                    <td class="text-center text-sm">${category}</td>
                    <td class="text-center tabular-nums font-semibold">${costFactor.toFixed(1)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-xs btn-primary select-material-btn" 
                                data-material="${materialName}">
                            Select
                        </button>
                    </td>
                `;

                // Click row to select
                row.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('select-material-btn')) {
                        selectMaterial(materialName);
                    }
                });

                // Click button to select
                const selectBtn = row.querySelector('.select-material-btn');
                selectBtn.addEventListener('click', () => selectMaterial(materialName));

                materialTableBody.appendChild(row);
            });
    }

    // Select material and close modal
    function selectMaterial(materialName) {
        if (materialConstructionSelect) {
            // Update the select dropdown
            materialConstructionSelect.value = materialName;

            // Update the visible display field
            if (rbixMaterialDisplay) {
                const factor = MaterialCostFactors[materialName];
                rbixMaterialDisplay.value = `${materialName} (Factor: ${factor.toFixed(1)})`;
            }

            // Trigger change event for any listeners
            materialConstructionSelect.dispatchEvent(new Event('change'));

            // Close modal
            materialModal.close();
        }
    }

    // Open modal on button click
    if (selectMaterialButton) {
        selectMaterialButton.addEventListener('click', () => {
            populateMaterialTable();
            materialSearch.value = '';
            materialModal.showModal();
        });
    }

    // Search functionality
    if (materialSearch) {
        materialSearch.addEventListener('input', (e) => {
            populateMaterialTable(e.target.value);
        });
    }

    // Initialize display if value exists
    if (materialConstructionSelect && materialConstructionSelect.value && rbixMaterialDisplay) {
        const currentMaterial = materialConstructionSelect.value;
        if (MaterialCostFactors[currentMaterial]) {
            const factor = MaterialCostFactors[currentMaterial];
            rbixMaterialDisplay.value = `${currentMaterial} (Factor: ${factor.toFixed(1)})`;
        } else {
            rbixMaterialDisplay.value = currentMaterial;
        }
    }
</script>

<!-- Thinning Calculations -->
<script src="{% static 'dashboard/js/calculations/thinning_calculations.js' %}"></script>
<script src="{% static 'dashboard/js/calculations/acid_corrosion.js' %}"></script>
<script src="{% static 'dashboard/js/calculations/amine_water_specialized.js' %}"></script>
<script src="{% static 'dashboard/js/calculations/external_damage.js' %}"></script>
<script src="{% static 'dashboard/js/calculations/brittle_fracture.js' %}"></script>
<script src="{% static 'dashboard/js/calculations/inspection_planning.js' %}"></script>
{% endblock %}