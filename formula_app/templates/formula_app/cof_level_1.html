{%extends 'theme/base.html'%}
{% load static %}

{%block title%}COF Level 1{%endblock%}

{% block nav_content %}
<div class="flex justify-end items-center h-full">
    <ul class="menu menu-horizontal p-0 hidden lg:flex text-white space-x-2">
        <li><a id="logout_btn" href="{% url 'logout' %}"
                class="btn btn-ghost text-white hover:bg-blue-800 transition duration-200">Log out</a></li>
        <li><a href="#" class="btn btn-ghost text-white hover:bg-blue-800 transition duration-200">Account</a></li>
    </ul>

    <label for="my-drawer" class="btn btn-square btn-ghost text-white lg:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            class="inline-block w-6 h-6 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </label>
</div>
{% endblock %}

{% block content %}
<div class="drawer h-full overflow-hidden">
    <input id="my-drawer" type="checkbox" class="drawer-toggle" />

    <div class="drawer-content flex flex-col h-full overflow-hidden">
        <main class="flex flex-1 h-full overflow-hidden">

            <!-- SIDEBAR -->
            <aside
                class="hidden lg:block w-64 bg-white p-6 shadow-xl border-r border-gray-200 flex-shrink-0 overflow-y-auto">
                {% include 'formula_app/includes/sidebar.html' %}
            </aside>

            <!-- MAIN CONTENT -->
            <section class="flex flex-1 flex-col bg-gray-50 h-full overflow-hidden p-6 lg:p-10 relative">

                <!-- HEADER -->
                <div class="mb-8 text-center lg:text-left">
                    <h1 class="text-3xl font-extrabold text-blue-900 mb-2">COF Level 1</h1>
                    <p class="text-gray-500">Determine the Representative Fluid and Associated Properties</p>
                </div>

                <!-- CONTENT SCROLLABLE -->
                <div class="flex-1 overflow-y-auto pr-2 space-y-6">

                    <!-- STEP 4.1.1: Representative Fluids -->
                    <div class="card bg-white shadow-sm border border-gray-200">
                        <div class="card-body p-6">
                            <h2 class="card-title text-blue-900 text-xl border-b pb-2 mb-4">
                                4.1.1 Representative Fluids
                            </h2>

                            <div class="form-control w-full max-w-md">
                                <label class="label">
                                    <span class="label-text font-semibold">Select Representative Fluid</span>
                                </label>
                                <p class="text-xs text-gray-500 mb-2">
                                    Select the representative fluid that most closely matches the fluid contained in the
                                    pressurized system being evaluated
                                </p>
                                <select id="select_fluid" class="select select-bordered w-full bg-gray-50">
                                    <option disabled selected>Select a fluid...</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>

                            <div class="form-control w-full max-w-md mt-4">
                                <label class="label">
                                    <span class="label-text font-semibold">Stored Phase</span>
                                </label>
                                <select id="select_phase" class="select select-bordered w-full bg-gray-50">
                                    <option disabled selected>Select Phase...</option>
                                    <option value="Liquid">Liquid</option>
                                    <option value="Vapor">Vapor / Gas</option>
                                </select>
                            </div>

                            <div class="form-control w-full max-w-md mt-4">
                                <label class="label">
                                    <span class="label-text font-semibold">Temperature (°F)</span>
                                </label>
                                <input type="number" id="input_temperature" placeholder="Enter temperature"
                                    class="input input-bordered w-full bg-gray-50" />
                            </div>

                            <!-- Fluid Details Display -->
                            <div id="fluid_details"
                                class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h3 class="text-sm font-bold text-gray-500 uppercase">Fluid Type</h3>
                                        <p id="fluid_type_display" class="text-lg font-bold text-blue-900">-</p>
                                    </div>
                                    <div>
                                        <h3 class="text-sm font-bold text-gray-500 uppercase">Examples</h3>
                                        <p id="fluid_examples_display" class="text-gray-700">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4.1.2: Fluid Properties -->
                    <div id="properties_card" class="card bg-white shadow-sm border border-gray-200 hidden">
                        <div class="card-body p-6">
                            <h2 class="card-title text-blue-900 text-xl border-b pb-2 mb-4">
                                4.1.2 Fluid Properties
                            </h2>
                            <p class="text-xs text-gray-500 mb-4">
                                Properties estimated for the selected representative fluid dependent on the stored
                                phase.
                            </p>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">

                                <div id="card_mw" class="transition-opacity duration-300">
                                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">MW</h3>
                                    <p id="prop_mw" class="text-xl font-bold text-gray-800">-</p>
                                    <span class="text-xs text-gray-400">lb/lb-mol</span>
                                </div>

                                <div id="card_density" class="transition-opacity duration-300">
                                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Liquid Density</h3>
                                    <p id="prop_density" class="text-xl font-bold text-gray-800">-</p>
                                    <span class="text-xs text-gray-400">lb/ft³</span>
                                </div>

                                <div id="card_nbp" class="transition-opacity duration-300">
                                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">NBP</h3>
                                    <p id="prop_nbp" class="text-xl font-bold text-gray-800">-</p>
                                    <span class="text-xs text-gray-400">°F</span>
                                </div>

                                <div id="card_ait" class="transition-opacity duration-300">
                                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">AIT</h3>
                                    <p id="prop_ait" class="text-xl font-bold text-gray-800">-</p>
                                    <span class="text-xs text-gray-400">°F</span>
                                </div>

                            </div>

                            <div class="divider my-4"></div>

                            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                                <div id="card_ambient" class="transition-opacity duration-300">
                                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Ambient State</h3>
                                    <span id="prop_ambient" class="badge badge-lg badge-ghost font-bold">-</span>
                                </div>

                                <div id="card_cp" class="col-span-2 transition-opacity duration-300">
                                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Ideal Gas Specific Heat
                                        (Cp) Constants</h3>
                                    <div class="overflow-x-auto">
                                        <table class="table table-xs table-zebra w-full">
                                            <thead>
                                                <tr>
                                                    <th>Eq.</th>
                                                    <th>A</th>
                                                    <th>B</th>
                                                    <th>C</th>
                                                    <th>D</th>
                                                    <th>E</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td id="prop_cp_eq" class="font-bold">-</td>
                                                    <td id="prop_cp_a">-</td>
                                                    <td id="prop_cp_b">-</td>
                                                    <td id="prop_cp_c">-</td>
                                                    <td id="prop_cp_d">-</td>
                                                    <td id="prop_cp_e">-</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="cp_result_container" class="mt-2 hidden">
                                        <span class="font-bold text-sm text-gray-700">Calculated Cp:</span>
                                        <span id="cp_calculated_value" class="font-bold text-blue-900 ml-2">-</span>
                                        <span class="text-xs text-gray-500">J/(kg·K)</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>


                    <!-- STEP 4.1.4: Estimation of Ideal Gas Specific Heat Capacity Ratio -->
                    <div id="ratio_k_card" class="card bg-white shadow-sm border border-gray-200 mt-6 hidden">
                        <div class="card-body p-6">
                            <h2 class="card-title text-blue-900 text-xl border-b pb-2 mb-4">
                                4.1.4 Estimation of Ideal Gas Specific Heat Capacity Ratio (k)
                            </h2>
                            <p class="text-xs text-gray-500 mb-4">
                                Calculated using Equation (3.1): \( k = \frac{C_p}{C_p - R} \)
                            </p>
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-gray-700">Specific Heat Ratio (k):</span>
                                <span id="val_ratio_k" class="text-2xl font-bold text-blue-900">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4.1.7: Calculation of Release Phase -->
                    <div id="release_phase_card" class="card bg-white shadow-sm border border-gray-200 mt-6 hidden">
                        <div class="card-body p-6">
                            <h2 class="card-title text-blue-900 text-xl border-b pb-2 mb-4">
                                4.1.7 Calculation of Release Phase
                            </h2>
                            <p class="text-xs text-gray-500 mb-4">
                                Determination of Final Phase for Consequence Calculation based on stored and ambient
                                conditions
                                (Table 4.3).
                            </p>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                                <div>
                                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Stored Phase</h3>
                                    <p id="disp_stored_phase" class="text-lg font-bold text-gray-700">-</p>
                                </div>
                                <div>
                                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Ambient Phase</h3>
                                    <p id="disp_ambient_phase" class="text-lg font-bold text-gray-700">-</p>
                                </div>
                                <div>
                                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-1 text-blue-900">Final Phase
                                    </h3>
                                    <span id="disp_final_phase"
                                        class="badge badge-lg badge-primary font-bold text-white">-</span>
                                </div>
                            </div>

                            <div id="phase_msg_container"
                                class="mt-4 p-3 bg-yellow-50 text-yellow-800 text-sm rounded-md hidden">
                                <span class="font-bold">Note:</span> <span id="phase_determination_msg"></span>
                            </div>

                        </div>
                    </div>

                    <!-- STEP 4.2: Release Hole Size Selection & GFF -->
                    <div id="hole_sizes_card_wrapper"
                        class="card bg-white shadow-sm border border-gray-200 mt-6 hidden">
                        <div class="card-body p-6">
                            <h2 class="card-title text-blue-900 text-xl border-b pb-2 mb-4">
                                4.2 Release Hole Size & GFF Selection
                            </h2>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                                <div class="form-control w-full">
                                    <label class="label">
                                        <span class="label-text font-semibold">Component Diameter (D) [inches]</span>
                                    </label>
                                    <input type="number" id="input_diameter" placeholder="e.g. 10" step="0.1"
                                        class="input input-bordered w-full bg-gray-50" />
                                </div>

                                <div class="form-control w-full">
                                    <label class="label">
                                        <span class="label-text font-semibold">Component Type (Table 3.1)</span>
                                    </label>
                                    <select id="select_component_type" class="select select-bordered w-full bg-gray-50">
                                        <option disabled selected>Select equipment type...</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                            </div>

                            <div id="hole_sizes_container" class="overflow-x-auto mt-6 hidden">
                                <table class="table table-zebra w-full text-center">
                                    <thead class="bg-gray-100 text-gray-600">
                                        <tr>
                                            <th>Hole Size</th>
                                            <th>Generic Size</th>
                                            <th>Diameter (dn) [in]</th>
                                            <th>GFF (failures/yr)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-sm">
                                        <tr>
                                            <td class="font-bold">1</td>
                                            <td>Small</td>
                                            <td id="val_d1">-</td>
                                            <td id="val_gff1">-</td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold">2</td>
                                            <td>Medium</td>
                                            <td id="val_d2">-</td>
                                            <td id="val_gff2">-</td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold">3</td>
                                            <td>Large</td>
                                            <td id="val_d3">-</td>
                                            <td id="val_gff3">-</td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold">4</td>
                                            <td>Rupture</td>
                                            <td id="val_d4">-</td>
                                            <td id="val_gff4">-</td>
                                        </tr>
                                        <tr class="bg-blue-50 border-t-2 border-blue-100">
                                            <td colspan="3" class="text-right font-bold text-blue-900">Total GFF:</td>
                                            <td id="val_gff_total" class="font-bold text-blue-900">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>

                    <!-- STEP 4.3: Release Rate Calculation -->
                    <div class="mt-8 mb-4 border-b-2 border-blue-900 pb-2">
                        <h1 class="text-2xl font-bold text-blue-900">4.3 Release Rate Calculation</h1>
                    </div>

                    <!-- STEP 4.3.2: Liquid Release Rate -->
                    <div id="liquid_release_card" class="card bg-white shadow-sm border border-gray-200 mt-6 hidden">
                        <div class="card-body p-6">
                            <h2 class="card-title text-blue-900 text-xl border-b pb-2 mb-4">
                                4.3.2 Liquid Release Rate Calculation
                            </h2>
                            <p class="text-xs text-gray-500 mb-4">
                                Calculated using Equation (3.3) for Liquid Phase.
                            </p>

                            <div class="mb-6">
                                <p class="mb-2 text-sm text-gray-700 font-semibold">Equation (3.3):</p>
                                <div class="overflow-x-auto">
                                    $$ W_n = C_d \cdot K_{v,n} \cdot \rho_l \cdot \frac{A_n}{C_1} \sqrt{ \frac{2 \cdot
                                    g_c \cdot (P_s - P_{atm})}{\rho_l} } $$
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="form-control w-full">
                                    <label class="label">
                                        <span class="label-text font-semibold">Storage Pressure (Ps) [psia]</span>
                                    </label>
                                    <input type="number" id="input_ps" placeholder="e.g. 64.7"
                                        class="input input-bordered w-full bg-gray-50" />
                                </div>
                                <div class="form-control w-full">
                                    <label class="label">
                                        <span class="label-text font-semibold">Atm. Pressure (Patm) [psi]</span>
                                    </label>
                                    <input type="number" id="input_patm" value="14.7" step="0.1"
                                        class="input input-bordered w-full bg-gray-50" />
                                </div>
                                <div class="form-control w-full">
                                    <label class="label">
                                        <span class="label-text font-semibold">Discharge Coeff. (Cd)</span>
                                    </label>
                                    <input type="number" id="input_cd" value="0.61" min="0.60" max="0.65" step="0.01"
                                        class="input input-bordered w-full bg-gray-50" />
                                    <label class="label">
                                        <span class="label-text-alt text-gray-400">Range: 0.60 - 0.65 (Rec: 0.61)</span>
                                    </label>
                                </div>
                                <div class="form-control w-full">
                                    <label class="label">
                                        <span class="label-text font-semibold">Viscosity Corr. (Kvn)</span>
                                    </label>
                                    <input type="number" id="input_kvn" value="1.0" step="0.1"
                                        class="input input-bordered w-full bg-gray-50" />
                                    <label class="label">
                                        <span class="label-text-alt text-gray-400">Rec: 1.0 (Conservative)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Constants Display -->
                            <div class="grid grid-cols-2 gap-4 mb-6 p-3 bg-gray-50 rounded text-sm text-gray-600">
                                <div>
                                    <span class="font-bold">Liquid Density (\(\rho_l\)):</span> <span
                                        id="disp_rho_l">-</span> lb/ft³
                                </div>
                                <div>
                                    <span class="font-bold">Gravitational Const. (\(g_c\)):</span> 32.174 lb·ft/lbf·s²
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="table table-zebra w-full text-center">
                                    <thead class="bg-gray-100 text-gray-600">
                                        <tr>
                                            <th>Hole Size</th>
                                            <th>Diameter [in]</th>
                                            <th>Release Rate (Wn) [lb/s]</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-sm">
                                        <tr>
                                            <td class="font-bold">1 (Small)</td>
                                            <td id="val_wn_d1">-</td>
                                            <td id="val_wn1" class="font-bold text-blue-900">-</td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold">2 (Medium)</td>
                                            <td id="val_wn_d2">-</td>
                                            <td id="val_wn2" class="font-bold text-blue-900">-</td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold">3 (Large)</td>
                                            <td id="val_wn_d3">-</td>
                                            <td id="val_wn3" class="font-bold text-blue-900">-</td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold">4 (Rupture)</td>
                                            <td id="val_wn_d4">-</td>
                                            <td id="val_wn4" class="font-bold text-blue-900">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 4.3.3 Vapor Release Rate Card -->
                    <div id="vapor_release_card"
                        class="card bg-white shadow-lg p-6 mb-6 hidden border-l-4 border-orange-500">
                        <h2 class="card-title text-orange-900 text-xl border-b pb-2 mb-4">
                            4.3.3 Vapor Release Rate Calculation
                        </h2>
                        <p class="text-xs text-gray-500 mb-4">
                            Calculated using Eq (3.6) [Sonic] or Eq (3.7) [Subsonic].
                        </p>

                        <!-- Equations Display (Toggle) -->
                        <details class="mb-6 collapse collapse-arrow border border-base-300 bg-base-100 rounded-box">
                            <summary class="collapse-title text-sm font-medium text-gray-700">
                                Show Equations (3.5, 3.6, 3.7)
                            </summary>
                            <div class="collapse-content overflow-x-auto text-xs">
                                <p class="mb-2"><strong>Eq 3.5 (Transition Pressure):</strong></p>
                                <div class="mb-4">$$ P_{trans} = P_{atm} \left( \frac{k+1}{2}
                                    \right)^{\frac{k}{k-1}} $$</div>
                                <p class="mb-2"><strong>Eq 3.6 (Sonic Flow, \(P_s > P_{trans}\)):</strong></p>
                                <div class="mb-4">$$ W_n = \frac{C_d}{C_2} A_n P_s \sqrt{ \frac{k \cdot MW \cdot
                                    g_c}{R \cdot T_s} \left(\frac{2}{k+1}\right)^{\frac{k+1}{k-1}} } $$</div>
                                <p class="mb-2"><strong>Eq 3.7 (Subsonic Flow, \(P_s \le P_{trans}\)):</strong></p>
                                <div>$$ W_n = \frac{C_d}{C_2} A_n P_s \sqrt{ \frac{MW \cdot g_c}{R \cdot T_s}
                                    \left(\frac{2k}{k-1}\right) \left(\frac{P_{atm}}{P_s}\right)^{\frac{2}{k}} \dots
                                    } $$</div>
                            </div>
                        </details>

                        <!-- Inputs -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="form-control w-full">
                                <label class="label"><span class="label-text font-semibold">Storage Pressure (\(P_s\))
                                        [psia]</span></label>
                                <input type="number" id="input_ps_vap" placeholder="e.g. 100"
                                    class="input input-bordered w-full bg-gray-50 bg-orange-50" />
                            </div>
                            <div class="form-control w-full">
                                <label class="label"><span class="label-text font-semibold">Atm. Pressure
                                        (\(P_{atm}\)) [psi]</span></label>
                                <input type="number" id="input_patm_vap" value="14.7" step="0.1"
                                    class="input input-bordered w-full bg-gray-50 bg-orange-50" />
                            </div>
                            <div class="form-control w-full">
                                <label class="label"><span class="label-text font-semibold">Discharge Coeff.
                                        (\(C_d\))</span></label>
                                <input type="number" id="input_cd_vap" value="1.0" min="0.61" max="1.0" step="0.01"
                                    class="input input-bordered w-full bg-gray-50 bg-orange-50" />
                                <label class="label"><span class="label-text-alt">Rec: 1.0 (Sonic), 0.61
                                        (Sub)</span></label>
                            </div>
                            <div class="form-control w-full">
                                <label class="label"><span class="label-text font-semibold">Conversion
                                        (\(C_2\))</span></label>
                                <input type="number" id="input_c2_vap" value="1" step="0.01"
                                    class="input input-bordered w-full bg-gray-50 bg-orange-50" />
                                <label class="label"><span class="label-text-alt">Update if needed</span></label>
                            </div>
                        </div>

                        <!-- Intermediate Values -->
                        <div
                            class="grid grid-cols-2 gap-4 mb-6 p-3 bg-orange-50 rounded text-sm text-gray-700 border border-orange-200">
                            <div><span class="font-bold">k (Ratio):</span> <span id="disp_k_vap">-</span></div>
                            <div><span class="font-bold">MW:</span> <span id="disp_mw_vap">-</span></div>
                            <div><span class="font-bold">Ts:</span> <span id="disp_ts_vap">-</span> °R</div>
                            <div><span class="font-bold">R Gas Const:</span> 1545.3</div>
                        </div>

                        <!-- Regime & Result -->
                        <div class="alert alert-info shadow-sm mb-4">
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    class="stroke-current flex-shrink-0 w-6 h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h3 class="font-bold">Flow Regime: <span id="disp_flow_regime"
                                            class="text-blue-900">-</span></h3>
                                    <div class="text-xs">Ptrans = <span id="disp_ptrans">-</span> psia</div>
                                </div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full text-center">
                                <thead class="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th>Hole Size</th>
                                        <th>Rate (\(W_n\)) [lb/s]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Small (\(d_1\))</td>
                                        <td class="font-bold text-orange-700" id="val_wn1_vap">-</td>
                                    </tr>
                                    <tr>
                                        <td>Medium (\(d_2\))</td>
                                        <td class="font-bold text-orange-700" id="val_wn2_vap">-</td>
                                    </tr>
                                    <tr>
                                        <td>Large (\(d_3\))</td>
                                        <td class="font-bold text-orange-700" id="val_wn3_vap">-</td>
                                    </tr>
                                    <tr>
                                        <td>Rupture (\(d_4\))</td>
                                        <td class="font-bold text-orange-700" id="val_wn4_vap">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- STEP 4.4: Fluid Inventory Calculation -->
                    <div id="fluid_inventory_card"
                        class="card bg-white shadow-lg p-6 mb-6 border-l-4 border-purple-500 hidden">
                        <h2 class="card-title text-purple-900 text-xl border-b pb-2 mb-4">
                            4.4 Estimate Fluid Inventory Available for Release
                        </h2>
                        <p class="text-xs text-gray-500 mb-4">
                            Calculate Available Mass based on Inventory Group (\(mass_{inv}\)) and Component Mass
                            (\(mass_{comp}\)).
                        </p>

                        <!-- Inputs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="form-control w-full">
                                <label class="label"><span class="label-text font-semibold">Inventory Group Mass
                                        (\(mass_{inv}\)) [lb]</span></label>
                                <input type="number" id="input_mass_inv" placeholder="e.g. 5000"
                                    class="input input-bordered w-full bg-purple-50" />
                            </div>
                            <div class="form-control w-full">
                                <label class="label"><span class="label-text font-semibold">Component Mass
                                        (\(mass_{comp}\)) [lb]</span></label>
                                <input type="number" id="input_mass_comp" placeholder="e.g. 1000"
                                    class="input input-bordered w-full bg-purple-50" />
                            </div>
                        </div>

                        <!-- Intermediate: W_max8 -->
                        <div class="alert alert-info shadow-sm mb-4 bg-purple-100 border-purple-200 text-purple-900">
                            <div class="flex flex-col">
                                <span class="font-bold text-sm">Max Release Rate (8" Hole):</span>
                                <span class="text-2xl font-bold" id="disp_w_max8">-</span> <span
                                    class="text-xs">lb/s</span>
                                <span class="text-xs italic mt-1">(Calculated using appropriate Release Rate Eq with d=8
                                    in)</span>
                            </div>
                        </div>

                        <!-- Results Table -->
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full text-center text-sm">
                                <thead class="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th>Hole Size</th>
                                        <th>Rate (\(W_n\))<br>[lb/s]</th>
                                        <th>Added Mass (\(mass_{add}\))<br>[lb]</th>
                                        <th>Available Mass (\(mass_{avail}\))<br>[lb]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Small (\(d_1\))</td>
                                        <td id="tbl_wn1">-</td>
                                        <td id="val_mass_add1" class="text-gray-600">-</td>
                                        <td id="val_mass_avail1" class="font-bold text-purple-700">-</td>
                                    </tr>
                                    <tr>
                                        <td>Medium (\(d_2\))</td>
                                        <td id="tbl_wn2">-</td>
                                        <td id="val_mass_add2" class="text-gray-600">-</td>
                                        <td id="val_mass_avail2" class="font-bold text-purple-700">-</td>
                                    </tr>
                                    <tr>
                                        <td>Large (\(d_3\))</td>
                                        <td id="tbl_wn3">-</td>
                                        <td id="val_mass_add3" class="text-gray-600">-</td>
                                        <td id="val_mass_avail3" class="font-bold text-purple-700">-</td>
                                    </tr>
                                    <tr>
                                        <td>Rupture (\(d_4\))</td>
                                        <td id="tbl_wn4">-</td>
                                        <td id="val_mass_add4" class="text-gray-600">-</td>
                                        <td id="val_mass_avail4" class="font-bold text-purple-700">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- STEP 4.5: Release Type Determination -->
                    <div id="release_type_card"
                        class="card bg-white shadow-lg p-6 mb-6 border-l-4 border-indigo-500 hidden">
                        <h2 class="card-title text-indigo-900 text-xl border-b pb-2 mb-4">
                            4.5 Determine Release Type
                        </h2>
                        <p class="text-xs text-gray-500 mb-4">
                            Classification as Instantaneous or Continuous based on Hole Size and Release Rate (API 581
                            Sec. 4.5.2).
                        </p>

                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full text-center text-sm">
                                <thead class="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th>Hole Size</th>
                                        <th>Diameter (\(d_n\))<br>[in]</th>
                                        <th>Rate (\(W_n\))<br>[lb/s]</th>
                                        <th>Release Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Small</td>
                                        <td id="rt_d1">-</td>
                                        <td id="rt_wn1">-</td>
                                        <td id="rt_type1" class="font-bold">-</td>
                                    </tr>
                                    <tr>
                                        <td>Medium</td>
                                        <td id="rt_d2">-</td>
                                        <td id="rt_wn2">-</td>
                                        <td id="rt_type2" class="font-bold">-</td>
                                    </tr>
                                    <tr>
                                        <td>Large</td>
                                        <td id="rt_d3">-</td>
                                        <td id="rt_wn3">-</td>
                                        <td id="rt_type3" class="font-bold">-</td>
                                    </tr>
                                    <tr>
                                        <td>Rupture</td>
                                        <td id="rt_d4">-</td>
                                        <td id="rt_wn4">-</td>
                                        <td id="rt_type4" class="font-bold">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- STEP 4.6: Detection and Isolation Systems -->
                    <div id="detection_isolation_card"
                        class="card bg-white shadow-lg p-6 mb-6 border-l-4 border-pink-500 hidden">
                        <h2 class="card-title text-pink-900 text-xl border-b pb-2 mb-4">
                            4.6 Detection and Isolation Systems
                        </h2>
                        <p class="text-xs text-gray-500 mb-4">
                            Assess impact of detection and isolation on release magnitude and duration (Tables 4.5, 4.6,
                            4.7).
                        </p>

                        <!-- Dropdowns -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="form-control w-full">
                                <label class="label"><span class="label-text font-semibold">Detection Classification
                                        (Table 4.5)</span></label>
                                <select id="select_detection" class="select select-bordered w-full bg-pink-50">
                                    <option disabled selected>Select Class...</option>
                                    <option value="A">A - Instrumentation (Auto)</option>
                                    <option value="B">B - Detectors (Remote)</option>
                                    <option value="C">C - Visual / Marginal</option>
                                </select>
                                <p id="desc_detection"
                                    class="text-xs text-gray-500 mt-2 italic px-1 h-12 overflow-y-auto"></p>
                            </div>
                            <div class="form-control w-full">
                                <label class="label"><span class="label-text font-semibold">Isolation Classification
                                        (Table 4.5)</span></label>
                                <select id="select_isolation" class="select select-bordered w-full bg-pink-50">
                                    <option disabled selected>Select Class...</option>
                                    <option value="A">A - Auto Isolation</option>
                                    <option value="B">B - Remote Manual</option>
                                    <option value="C">C - Manual Valves</option>
                                </select>
                                <p id="desc_isolation"
                                    class="text-xs text-gray-500 mt-2 italic px-1 h-12 overflow-y-auto"></p>
                            </div>
                        </div>

                        <!-- Results -->
                        <div class="alert alert-info shadow-sm mb-4 bg-pink-50 border-pink-200 text-pink-900">
                            <div>
                                <span class="font-bold">Reduction Factor (\(fact_{di}\)):</span>
                                <span id="val_fact_di" class="text-xl font-bold ml-2">-</span>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full text-center text-sm">
                                <thead class="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th>Hole Size</th>
                                        <th>Max Leak Duration (\(ld_{max}\))<br>[min]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Small (\(d_1\))</td>
                                        <td id="val_ld1" class="font-bold text-pink-900">-</td>
                                    </tr>
                                    <tr>
                                        <td>Medium (\(d_2\))</td>
                                        <td id="val_ld2" class="font-bold text-pink-900">-</td>
                                    </tr>
                                    <tr>
                                        <td>Large (\(d_3\))</td>
                                        <td id="val_ld3" class="font-bold text-pink-900">-</td>
                                    </tr>
                                    <tr>
                                        <td>Rupture (\(d_4\))</td>
                                        <td id="val_ld4" class="font-bold text-pink-900">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- STEP 4.7: Final Release Rate and Mass -->
                    <div id="release_mass_card"
                        class="card bg-white shadow-lg p-6 mb-6 border-l-4 border-emerald-500 hidden">
                        <h2 class="card-title text-emerald-900 text-xl border-b pb-2 mb-4">
                            4.7 Final Release Rate & Mass
                        </h2>
                        <p class="text-xs text-gray-500 mb-4">
                            Calculated using Eqs 3.12, 3.14, and 3.13. Limits release duration by inventory.
                        </p>

                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full text-center text-sm">
                                <thead class="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th>Hole Size</th>
                                        <th>Adj Rate (\(rate_n\))<br>[lb/s]</th>
                                        <th>Duration (\(ld_n\))<br>[s]</th>
                                        <th>Mass (\(mass_n\))<br>[lb]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Small</td>
                                        <td id="fin_rate1">-</td>
                                        <td id="fin_dur1">-</td>
                                        <td id="fin_mass1" class="font-bold text-emerald-700">-</td>
                                    </tr>
                                    <tr>
                                        <td>Medium</td>
                                        <td id="fin_rate2">-</td>
                                        <td id="fin_dur2">-</td>
                                        <td id="fin_mass2" class="font-bold text-emerald-700">-</td>
                                    </tr>
                                    <tr>
                                        <td>Large</td>
                                        <td id="fin_rate3">-</td>
                                        <td id="fin_dur3">-</td>
                                        <td id="fin_mass3" class="font-bold text-emerald-700">-</td>
                                    </tr>
                                    <tr>
                                        <td>Rupture</td>
                                        <td id="fin_rate4">-</td>
                                        <td id="fin_dur4">-</td>
                                        <td id="fin_mass4" class="font-bold text-emerald-700">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- STEP 4.8: Flammable Consequence -->
                    <div id="flammable_consequence_card"
                        class="card bg-white shadow-lg p-6 mb-6 border-l-4 border-red-500 hidden">
                        <h2 class="card-title text-red-900 text-xl border-b pb-2 mb-4">
                            4.8 Flammable & Explosive Consequence
                        </h2>

                        <!-- Non-Flammable Warning -->
                        <div id="non_flammable_msg" class="alert alert-warning shadow-sm mb-4 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                                <h3 class="font-bold">Non-Flammable Fluid</h3>
                                <div class="text-xs">Selected fluid is not flammable (Constants unavailable).
                                    Consequence is 0.</div>
                            </div>
                        </div>

                        <!-- Mitigation System Input -->
                        <div class="form-control w-full mb-6">
                            <label class="label"><span class="label-text font-semibold">Mitigation System (Table
                                    4.10)</span></label>
                            <select id="select_mitigation" class="select select-bordered w-full bg-red-50">
                                <option value="None" selected>None/No Mitigation (0%)</option>
                                <option value="InventoryBlowdown">Inventory blowdown, coupled with isolation system
                                    (25%)</option>
                                <option value="FireWaterDeluge">Fire water deluge system and monitors (20%)</option>
                                <option value="FireWaterMonitors">Fire water monitors only (5%)</option>
                                <option value="FoamSpray">Foam spray system (15%)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-2 italic">Select the mitigation system present to apply
                                reduction factor.</p>
                        </div>

                        <div class="divider">FINAL CONSEQUENCE AREAS</div>

                        <!-- Final Results Table -->
                        <div class="overflow-x-auto mb-4">
                            <table class="table table-zebra w-full text-center text-sm">
                                <thead class="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th>Component Damage Area<br>(\(CA_{cmd}^{flam}\)) [ft²]</th>
                                        <th>Personnel Injury Area<br>(\(CA_{inj}^{flam}\)) [ft²]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="text-2xl">
                                        <td id="val_final_cmd" class="font-bold text-red-700">-</td>
                                        <td id="val_final_inj" class="font-bold text-orange-700">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Collapse for Details -->
                        <div class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box">
                            <input type="checkbox" />
                            <div class="collapse-title font-medium text-gray-700">
                                View Detailed Calculation Per Hole Size
                            </div>
                            <div class="collapse-content">
                                <div class="overflow-x-auto">
                                    <table class="table table-xs table-zebra w-full text-center">
                                        <thead>
                                            <tr class="text-gray-500">
                                                <th>Hole Size</th>
                                                <th>CMD Area [ft²]</th>
                                                <th>INJ Area [ft²]</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="font-bold">Small</td>
                                                <td id="det_cmd1">-</td>
                                                <td id="det_inj1">-</td>
                                            </tr>
                                            <tr>
                                                <td class="font-bold">Medium</td>
                                                <td id="det_cmd2">-</td>
                                                <td id="det_inj2">-</td>
                                            </tr>
                                            <tr>
                                                <td class="font-bold">Large</td>
                                                <td id="det_cmd3">-</td>
                                                <td id="det_inj3">-</td>
                                            </tr>
                                            <tr>
                                                <td class="font-bold">Rupture</td>
                                                <td id="det_cmd4">-</td>
                                                <td id="det_inj4">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-xs text-gray-400 mt-2">
                                    Shows the intermediate consequence areas (blended & mitigated) for each release size
                                    before GFF weighting.
                                </p>
                            </div>
                        </div>

                        <p class="text-xs text-gray-400 mt-4 text-center">
                            Weighted probability average based on Hole Size GFF and Blended Release Types.
                        </p>
                    </div>

                    <!-- MOBILE SIDEBAR -->
                    <div class="drawer-side z-40">
                        <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
                        <aside class="w-64 bg-white p-4 shadow-2xl flex-shrink-0">
                            {% include 'formula_app/includes/sidebar.html' %}
                        </aside>
                    </div>
                </div>
                {% endblock %}

                {% block scripts %}
                <script type="module" src="{% static 'formula_app/js/cof_level_1.js' %}"></script>
                {% endblock %}